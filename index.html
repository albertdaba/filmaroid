<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera PWA – Film App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mrs+Saint+Delafield&display=swap">
  <style>
    /* ---------- SHARED STYLES ---------- */
    body{margin:0;background:#000;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;overflow:hidden}
    html{height:100vh;overflow:hidden}                /* root stays locked */

    video,img{width:100%;max-width:480px;aspect-ratio:3/4;object-fit:contain;background:#000}
    #menu-exit-btn,#gallery-btn{padding:8px;font-size:16px;border:1px solid #fff;border-radius:6px;background:rgba(255,255,255,.2);color:#fff;cursor:pointer}
    #shutter{position:fixed;right:20px;bottom:50%;transform:translateY(50%);width:70px;height:70px;border-radius:50%;border:4px solid #fff;background:rgba(255,255,255,.1);cursor:pointer;z-index:10}
    #save-btn{position:fixed;bottom:20px;left:calc(50% + 100px);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer;z-index:12}
    #menu-btn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:26px;text-align:center;line-height:44px;backdrop-filter:blur(6px);cursor:pointer;z-index:11}
    #next-btn{position:fixed;right:20px;top:25%;transform:translateY(-50%);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;cursor:pointer;display:none;z-index:12}

    /* ---------- RADIAL SELECTOR ---------- */
    #cameraRadialTrigger{position:fixed;left:10px;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:24px;text-align:center;line-height:44px;cursor:pointer;z-index:20;backdrop-filter:blur(6px);user-select:none;-webkit-user-select:none}
    #cameraRadialMenu{position:fixed;left:44px;top:50%;width:200px;height:200px;margin-left:-20px;margin-top:-100px;pointer-events:none;z-index:21}
    .camera-option{position:absolute;background:rgba(255,255,255,.15);border:1px solid #fff;color:#fff;padding:6px 12px;border-radius:6px;font-size:14px;cursor:pointer;white-space:nowrap;pointer-events:auto;transform:translate(-50%,-50%);transition:background .2s}

    /* ---------- OTHER CONTROLS ---------- */
    #controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%) translateY(100%);background:rgba(0,0,0,.85);padding:12px;border-radius:10px;transition:.3s ease;opacity:0;pointer-events:none;display:flex;flex-direction:column;gap:12px;width:calc(100% - 32px);max-width:480px;z-index:20}
    #controls.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
    #photo{user-select:auto;-webkit-user-select:auto;pointer-events:auto}
    input[type=range],select{width:100%}
    label{font-size:14px}
    #cameraSelect{position:fixed;top:12px;left:12px;z-index:15;background:rgba(0,0,0,.7);color:#fff;border:1px solid #fff;border-radius:6px;padding:4px;font-size:16px}
    *{user-select:none;-webkit-user-select:none}

    /* ---------- TEXT OVERLAY ---------- */
    #text-btn{position:fixed;bottom:20px;left:calc(50% - 120px);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer;z-index:12}
    #text-input-modal{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);padding:12px;border-radius:10px;display:flex;gap:10px;width:calc(100% - 32px);max-width:480px;z-index:25}
    #text-input{flex:1;padding:6px;border:1px solid #fff;border-radius:4px;background:rgba(255,255,255,.1);color:#fff;font-size:16px;user-select:auto;-webkit-user-select:auto}
    #text-submit,#text-cancel{padding:6px 12px;border:1px solid #fff;border-radius:4px;background:rgba(255,255,255,.2);color:#fff;cursor:pointer}

    /* ---------- COLOR MIX UI ---------- */
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{width:26px;height:26px;border-radius:50%;border:2px solid #fff;cursor:pointer;box-shadow:0 0 0 2px rgba(255,255,255,.15) inset}
    .chip.sel{box-shadow:0 0 0 3px #fff inset}
    .small{font-size:12px;opacity:.9}
    .divider{height:1px;background:rgba(255,255,255,.2);margin:4px 0}
  </style>
</head>
<body>

<select id="cameraSelect"></select>
<video id="video" autoplay playsinline></video>
<img id="photo" style="display:none">
<canvas id="canvas" style="display:none"></canvas>

<div id="menu-btn">☰</div>
<div id="next-btn">↩ Next</div>
<button id="save-btn" style="display:none">Save</button>
<button id="shutter"></button>

<!-- radial selector elements -->
<div id="cameraRadialTrigger"></div>
<div id="cameraRadialMenu"></div>

<div id="controls">
  <label>Film Simulation
    <select id="film">
      <option value="kodachrome">Kodachrome</option>
      <option value="acros">Acros (Monochrome)</option>
    </select>
  </label>
  <label>JPEG Compression (<span id="jpeg-quality-val">60</span>%)
    <input type="range" id="jpeg-quality" min="20" max="100" value="60">
  </label>
  <label>Film Grain (<span id="grain-val">19</span>)
    <input type="range" id="grain" min="0" max="50" value="19">
  </label>

  <!-- —— COLOR MIX (H/S/L) —— -->
  <div class="divider"></div>
  <div class="row">
    <input type="checkbox" id="cm-enable">
    <label for="cm-enable" style="margin:0">Enable Per-Color Adjustments</label>
  </div>
  <div id="cm-wrap" style="display:none">
    <div class="row" id="cm-palette" aria-label="Color buckets">
      <!-- colored chips inserted by JS -->
    </div>
    <div class="row small"><span id="cm-label">Red</span> &nbsp;|&nbsp; Hue <span id="cm-hv">0</span>° &nbsp; Sat <span id="cm-sv">0</span> &nbsp; Lum <span id="cm-lv">0</span></div>
    <label>Hue Shift (°)
      <input type="range" id="cm-h" min="-30" max="30" value="0">
    </label>
    <label>Saturation (-100…+100)
      <input type="range" id="cm-s" min="-100" max="100" value="0">
    </label>
    <label>Luminance (-100…+100)
      <input type="range" id="cm-l" min="-100" max="100" value="0">
    </label>
    <div class="row">
      <button id="cm-reset" style="padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer">Reset Color Mix</button>
    </div>
  </div>
  <!-- —— /COLOR MIX —— -->

  <button id="menu-exit-btn">Exit Menu</button>
  <button id="gallery-btn">View Gallery</button>
</div>

<button id="text-btn" style="display:none">TEXT</button>
<div id="text-input-modal" style="display:none">
  <input type="text" id="text-input" maxlength="50" placeholder="Enter text">
  <button id="text-submit">OK</button>
  <button id="text-cancel">Cancel</button>
</div>

<script>
/* ---------- DOM refs & state ---------- */
const video        = document.getElementById('video');
const canvas       = document.getElementById('canvas');
const photo        = document.getElementById('photo');
const shutter      = document.getElementById('shutter');
const saveBtn      = document.getElementById('save-btn');
const nextBtn      = document.getElementById('next-btn');
const menuBtn      = document.getElementById('menu-btn');
const controls     = document.getElementById('controls');
const grainSlider  = document.getElementById('grain');
const grainVal     = document.getElementById('grain-val');
const filmSelect   = document.getElementById('film');
const cameraSelect = document.getElementById('cameraSelect');
const jpegSlider   = document.getElementById('jpeg-quality');
const jpegVal      = document.getElementById('jpeg-quality-val');
const textBtn      = document.getElementById('text-btn');
const textModal    = document.getElementById('text-input-modal');
const textInput    = document.getElementById('text-input');
const textSubmit   = document.getElementById('text-submit');
const textCancel   = document.getElementById('text-cancel');

/* ----- radial selector refs ----- */
const cameraRadialTrigger = document.getElementById('cameraRadialTrigger');
const cameraRadialMenu    = document.getElementById('cameraRadialMenu');

/* ----- Color Mix refs ----- */
const cmEnable = document.getElementById('cm-enable');
const cmWrap   = document.getElementById('cm-wrap');
const cmPalette= document.getElementById('cm-palette');
const cmH      = document.getElementById('cm-h');
const cmS      = document.getElementById('cm-s');
const cmL      = document.getElementById('cm-l');
const cmHV     = document.getElementById('cm-hv');
const cmSV     = document.getElementById('cm-sv');
const cmLV     = document.getElementById('cm-lv');
const cmLabel  = document.getElementById('cm-label');
const cmReset  = document.getElementById('cm-reset');

/* ---------- helpers ---------- */
function lockScroll(){
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow           = 'hidden';
  window.scrollTo(0,0);
}

/* ---------- state ---------- */
let stream   = null,
    grainAmt = +grainSlider.value,
    film     = filmSelect.value,
    jpegQ    = +jpegSlider.value,
    userText = '',
    imgData  = null,
    dim      = null;

/* ---------- COLOR MIX state ---------- */
const CM_KEY = 'colorMixSettingsV1';
const colors = [
  {name:'Red',     css:'#ff3b30', center:0.00},
  {name:'Orange',  css:'#ff9500', center:0.06},
  {name:'Yellow',  css:'#ffcc00', center:0.12},
  {name:'Green',   css:'#34c759', center:0.33},
  {name:'Aqua',    css:'#32d7d7', center:0.50},
  {name:'Blue',    css:'#007aff', center:0.62},
  {name:'Purple',  css:'#9b59ff', center:0.75},
  {name:'Magenta', css:'#ff2d7a', center:0.88},
];
// half-width of each hue bucket (0..0.5); broader around oranges/reds for skin
const hueWidth = [0.09,0.10,0.08,0.07,0.06,0.07,0.07,0.08];
let cmIdx = 0; // currently selected color chip

// deltas are arrays of length 8 (one per bucket)
// ΔHue in turns [-0.0833..+0.0833] (±30°), ΔSat and ΔLum in [-0.5..+0.5]
let cmState = {
  enable: false,
  dH: new Array(8).fill(0),
  dS: new Array(8).fill(0),
  dL: new Array(8).fill(0),
};
// restore saved state if any
try{
  const saved = JSON.parse(localStorage.getItem(CM_KEY));
  if (saved && Array.isArray(saved.dH) && Array.isArray(saved.dS) && Array.isArray(saved.dL)){
    cmState = { enable: !!saved.enable, dH: saved.dH, dS: saved.dS, dL: saved.dL };
  }
}catch{}

/* ---------- sliders & simple UI ---------- */
grainSlider.oninput = () => { grainAmt = +grainSlider.value; grainVal.textContent = grainAmt; };
filmSelect.onchange = () => { film = filmSelect.value; };
jpegSlider.oninput  = () => { jpegQ  = +jpegSlider.value; jpegVal.textContent = jpegQ; };
menuBtn.onclick     = () => controls.classList.toggle('show');

/* ---------- Color Mix UI build ---------- */
function buildPalette(){
  cmPalette.innerHTML = '';
  colors.forEach((c, i) => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (i===cmIdx ? ' sel':'');
    chip.style.background = c.css;
    chip.title = c.name;
    chip.addEventListener('click', () => { cmIdx = i; refreshCmControls(); buildPalette(); });
    cmPalette.appendChild(chip);
  });
}
function refreshCmControls(){
  cmEnable.checked = cmState.enable;
  cmWrap.style.display = cmState.enable ? 'block' : 'none';
  cmLabel.textContent = colors[cmIdx].name;
  // UI values are human-friendly (degrees, percent); convert from internal
  cmH.value = Math.round((cmState.dH[cmIdx] || 0) * 360);  // turns→degrees
  cmS.value = Math.round((cmState.dS[cmIdx] || 0) * 200);  // [-0.5,0.5]→[-100,100]
  cmL.value = Math.round((cmState.dL[cmIdx] || 0) * 200);
  cmHV.textContent = cmH.value;
  cmSV.textContent = cmS.value;
  cmLV.textContent = cmL.value;
}
function saveCmState(){
  localStorage.setItem(CM_KEY, JSON.stringify(cmState));
}
cmEnable.addEventListener('change', () => { cmState.enable = cmEnable.checked; saveCmState(); refreshCmControls(); });
cmH.addEventListener('input', () => { cmState.dH[cmIdx] = (+cmH.value)/360; cmHV.textContent = cmH.value; saveCmState(); });
cmS.addEventListener('input', () => { cmState.dS[cmIdx] = (+cmS.value)/200; cmSV.textContent = cmS.value; saveCmState(); });
cmL.addEventListener('input', () => { cmState.dL[cmIdx] = (+cmL.value)/200; cmLV.textContent = cmL.value; saveCmState(); });
cmReset.addEventListener('click', () => {
  cmState.dH.fill(0); cmState.dS.fill(0); cmState.dL.fill(0); saveCmState(); refreshCmControls();
});

/* init CM UI */
buildPalette();
refreshCmControls();

/* ---------- NEXT / MENU ---------- */
nextBtn.onclick     = () => {
  document.documentElement.style.overflow = 'hidden';
  document.body.style.position  = 'fixed';
  document.body.style.width     = '100%';
  window.scrollTo(0, 0);
  lockScroll();
  video.style.display   = 'block';
  photo.style.display   = 'none';
  nextBtn.style.display = 'none';
  textBtn.style.display = 'none';
  saveBtn.style.display = 'none';
  imgData  = null;
  dim      = null;
  userText = '';
};

/* ---------- camera core ---------- */
cameraSelect.onchange = () => bootCam(cameraSelect.value);

async function bootCam(id = null){
  if (stream) stream.getTracks().forEach(t => t.stop());
  const c = { video: id
                ? { deviceId:{exact:id}, width:{ideal:4096}, height:{ideal:2160} }
                : { facingMode:{exact:'environment'}, width:{ideal:4096}, height:{ideal:2160} } };
  try{
    stream = await navigator.mediaDevices.getUserMedia(c);
    video.srcObject = stream;
    await video.play();
    await cams();
  }catch(e){
    alert('Camera error: ' + e.message);
  }
}

async function cams(){
  const v = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput');
  const current = cameraSelect.value;
  cameraSelect.innerHTML = '';
  v.forEach((d,i) => {
    const o = document.createElement('option');
    o.value = d.deviceId;
    o.textContent = d.label || `Camera ${i+1}`;
    cameraSelect.appendChild(o);
  });
  if (current) cameraSelect.value = current;
}

/* ---------- radial-selector logic ---------- */
let radialTimeout       = null;
let radialActive        = false;
let currentHoveredOpt   = null;

cameraRadialTrigger.addEventListener('pointerdown', () => {
  radialTimeout = setTimeout(() => {
    showCameraRadialMenu();
    radialActive = true;
  }, 300);
});

document.addEventListener('pointermove', e => {
  if (!radialActive) return;
  const opts = document.querySelectorAll('.camera-option');
  let closest = null;
  let minDist = Infinity;
  opts.forEach(opt => {
    const r  = opt.getBoundingClientRect();
    const cx = r.left + r.width  / 2;
    const cy = r.top  + r.height / 2;
    const dx = e.clientX - cx;
    const dy = e.clientY - cy;
    const d  = Math.hypot(dx, dy);
    if (d < minDist && d < 120) { minDist = d; closest = opt; }
    opt.style.background = 'rgba(255,255,255,0.15)';
  });
  currentHoveredOpt = closest;
  if (closest) closest.style.background = 'rgba(255,255,255,0.4)';
});

document.addEventListener('pointerup', () => {
  clearTimeout(radialTimeout);
  if (radialActive){
    if (currentHoveredOpt){
      const id = currentHoveredOpt.getAttribute('data-device-id');
      cameraSelect.value = id;
      bootCam(id);
    }
    cameraRadialMenu.innerHTML = '';
    radialActive      = false;
    currentHoveredOpt = null;
  }
});

function showCameraRadialMenu(){
  cameraRadialMenu.innerHTML = '';
  const opts      = Array.from(cameraSelect.options);
  const count     = opts.length;
  const showCnt   = Math.max(1, Math.min(7, count));
  const startA    = -Math.PI/4;
  const endA      =  Math.PI/4;
  const spread    = endA - startA;
  const radius    = 90 + (showCnt - 1) * 6;

  opts.forEach((o, idx) => {
    const ang = startA + idx * (spread / (showCnt - 1 || 1));
    const x   = Math.cos(ang) * radius + 100;
    const y   = Math.sin(ang) * radius + 100;

    const btn = document.createElement('div');
    btn.className = 'camera-option';
    btn.style.left      = `${x}px`;
    btn.style.top       = `${y}px`;
    btn.textContent     = o.textContent;
    btn.setAttribute('data-device-id', o.value);
    btn.addEventListener('pointerup', e => {
      e.stopPropagation();
      cameraSelect.value = btn.dataset.deviceId;
      bootCam(btn.dataset.deviceId);
      cameraRadialMenu.innerHTML = '';
      radialActive = false;
    });
    cameraRadialMenu.appendChild(btn);
  });
}

/* ---------- text modal ---------- */
function showModal(){ textModal.style.display='flex'; textInput.focus(); }
function hideModal(){ textModal.style.display='none'; textInput.value=''; lockScroll(); }

textBtn.onclick     = showModal;
textCancel.onclick  = hideModal;
textSubmit.onclick  = () => { userText = textInput.value.trim(); userText && (imgData ? updateTxt() : shoot()); hideModal(); };
textInput.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); textSubmit.click(); }});

/* ---------- small color helpers (sRGB domain) ---------- */
function rgbToHsv(r,g,b){ // r,g,b in 0..255 -> hsv: h in [0,1), s,v in [0,1]
  r/=255; g/=255; b/=255;
  const M = Math.max(r,g,b), m = Math.min(r,g,b), d = M - m;
  let h = 0;
  if (d > 1e-6){
    if (M === r)      h = ((g - b) / d) % 6;
    else if (M === g) h = (b - r) / d + 2;
    else              h = (r - g) / d + 4;
    h /= 6;
    if (h < 0) h += 1;
  }
  const s = M <= 1e-6 ? 0 : d / M;
  return [h, s, M];
}
function hsvToRgb(h,s,v){ // returns [r,g,b] in 0..255
  h = (h%1+1)%1;
  const x = h*6, i = Math.floor(x), f = x - i;
  const p = v*(1-s), q = v*(1-s*f), t = v*(1-s*(1-f));
  let r,g,b;
  if (i===0){ r=v; g=t; b=p; }
  else if (i===1){ r=q; g=v; b=p; }
  else if (i===2){ r=p; g=v; b=t; }
  else if (i===3){ r=p; g=q; b=v; }
  else if (i===4){ r=t; g=p; b=v; }
  else           { r=v; g=p; b=q; }
  return [Math.max(0,Math.min(255,Math.round(r*255))),
          Math.max(0,Math.min(255,Math.round(g*255))),
          Math.max(0,Math.min(255,Math.round(b*255)))];
}
function hueDelta(a,b){ // circular distance in turns [0..0.5]
  const d = Math.abs(a-b);
  return Math.min(d, 1 - d);
}
function bucketWeight(h, s, center, halfWidth){
  const dh = hueDelta(h, center);
  if (dh >= halfWidth) return 0;
  // smooth cosine falloff 0..1, with neutral suppression so grays aren't hit hard
  const wHue = 0.5 * (1 + Math.cos(Math.PI * (dh/halfWidth)));
  const minChroma = 0.02, maxChroma = 0.95;
  const gate = Math.min(1, Math.max(0, (s - minChroma) / (maxChroma - minChroma)));
  return wHue * gate;
}

/* ---------- shoot ---------- */
shutter.onclick = () => { userText=''; shoot(); };

function shoot(){
  if (!video.videoWidth){ alert('Wait for camera'); return; }

  const w   = video.videoWidth,
        h   = video.videoHeight,
        b   = Math.floor(Math.min(w,h) * 0.09),
        fw  = w + b*2,
        bot = b*2,
        fh  = h + b + bot;

  canvas.width  = fw;
  canvas.height = fh;
  dim           = {fw, fh, b, bot};

  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,fw,fh);
  ctx.drawImage(video, b, b, w, h);

  const data = ctx.getImageData(b,b,w,h);
  const d    = data.data;

  // ------- processing per pixel (sRGB space, hsv approx) -------
  const useColorMix = cmState.enable && film !== 'acros';
  for (let i=0; i<d.length; i+=4){
    let r = d[i], g = d[i+1], bl = d[i+2];

    // film sim (simple look)
    if (film === 'acros'){
      const a = (r+g+bl)/3;
      r = g = bl = a;
    }else{
      const a = (r+g+bl)/3;
      r = r*.85 + a*.15;
      g = g*.85 + a*.15;
      bl= bl*.85+ a*.15;
    }

    // ---- per-color adjustments (Color Mix) ----
    if (useColorMix){
      let [hue, sat, val] = rgbToHsv(r,g,bl); // hue in turns
      let sumDH=0, sumDS=0, sumDL=0, sumW=0;
      for (let k=0; k<8; k++){
        const wgt = bucketWeight(hue, sat, colors[k].center, hueWidth[k]);
        if (wgt>0){
          sumW  += wgt;
          sumDH += wgt * (cmState.dH[k] || 0);
          sumDS += wgt * (cmState.dS[k] || 0);
          sumDL += wgt * (cmState.dL[k] || 0);
        }
      }
      if (sumW>0){
        // apply combined deltas (already weighted)
        hue = (hue + sumDH);                // wrap happens in hsvToRgb
        sat = Math.max(0, Math.min(1, sat + sumDS));
        val = Math.max(0, Math.min(1, val + sumDL));
        [r,g,bl] = hsvToRgb(hue, sat, val);
      }
    }

    // grain last (sRGB domain)
    if (grainAmt){
      const n = (Math.random() - .5) * 2 * grainAmt;
      r += n; g += n; bl += n;
    }

    d[i]   = r;
    d[i+1] = g;
    d[i+2] = bl;
    // d[i+3] alpha unchanged
  }

  imgData = data;
  ctx.putImageData(data, b, b);
  drawTxt(ctx);

  // sRGB JPEG output (unchanged behavior)
  photo.src           = canvas.toDataURL('image/jpeg', 1.0);
  photo.style.display = 'block';
  video.style.display = 'none';
  nextBtn.style.display = 'block';
  textBtn.style.display = 'block';
  saveBtn.style.display = 'block';
  lockScroll();
}

function updateTxt(){
  const {fw, fh, b, bot} = dim;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,fw,fh);
  ctx.putImageData(imgData, b, b);
  drawTxt(ctx);
  photo.src = canvas.toDataURL('image/jpeg', 1.0);
}

function drawTxt(ctx){
  if (!userText) return;
  const {fw, fh, bot} = dim;
  let fs = 131;
  ctx.font = `${fs}px "Mrs Saint Delafield"`;
  while (ctx.measureText(userText).width > fw-20 && fs > 16){
    fs--;
    ctx.font = `${fs}px "Mrs Saint Delafield"`;
  }
  ctx.fillStyle   = '#000';
  ctx.textAlign   = 'center';
  ctx.textBaseline= 'middle';
  ctx.fillText(userText, fw/2, fh - bot/2);
}

/* ---------- save ---------- */
saveBtn.onclick = () => {
  if (!dim){ alert('Take a photo first'); return; }
  const {fw, fh} = dim,
        scale    = 1810/4420,
        tmp      = document.createElement('canvas');

  tmp.width  = Math.floor(fw*scale);
  tmp.height = Math.floor(fh*scale);
  tmp.getContext('2d').drawImage(canvas,0,0,tmp.width,tmp.height);

  tmp.toBlob(blob => {
    if (!blob){ alert('Save failed'); return; }
    const a   = document.createElement('a');
    a.href    = URL.createObjectURL(blob);
    a.download= `photo-${Date.now()}.jpg`;
    a.click();
    URL.revokeObjectURL(a.href);

    const fr = new FileReader();
    fr.onloadend = () => localStorage.setItem(`saved-photo-${Date.now()}`, fr.result);
    fr.readAsDataURL(blob);
  }, 'image/jpeg', jpegQ/100);
};

/* ---------- gallery ---------- */
document.getElementById('gallery-btn').onclick = () => {
  const gal  = document.getElementById('gallery-content');
  gal.innerHTML = '';
  const keys = Object.keys(localStorage).filter(k => k.startsWith('saved-photo-')).sort().reverse();

  if (!keys.length){
    gal.innerHTML = '<p style="color:#fff">No saved images.</p>';
  }else{
    keys.forEach(k => {
      const i = document.createElement('img');
      i.src   = localStorage.getItem(k);
      i.style.width = '100px';
      gal.appendChild(i);
    });
  }
  document.getElementById('gallery-overlay').style.display = 'block';
};
document.getElementById('menu-exit-btn').onclick = () => controls.classList.remove('show');

/* ---------- service worker & context menu ---------- */
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
document.addEventListener('contextmenu', e => { if (e.target.id !== 'photo') e.preventDefault(); }, {passive:false});

/* ---------- kick things off ---------- */
bootCam();
lockScroll();
</script>

<div id="gallery-overlay" style="display:none;position:fixed;inset:0;background:#000;z-index:99;overflow:auto;padding:10px">
  <button onclick="this.parentNode.style.display='none'" style="position:fixed;top:10px;right:10px;z-index:100;">Close</button>
  <div id="gallery-content" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:50px"></div>
</div>
</body>
</html>