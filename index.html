<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera PWA â€“ Film App with GIF</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mrs+Saint+Delafield&display=swap">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
  <style>
:root { --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-top: env(safe-area-inset-top, 0px); }
* { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; height: 100vh; overflow: hidden; position: fixed; width: 100%; }
#viewfinder-container { position: fixed; top: var(--safe-top); left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: #000; }
video, canvas, #photo { width: 100%; max-width: 480px; aspect-ratio: 3/4; object-fit: contain; background: #000; }
#video { display: block; } canvas, #photo { display: none; }
#top-bar { position: fixed; top: var(--safe-top); left: 0; right: 0; height: 60px; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; z-index: 10; pointer-events: none; }
#top-bar button { pointer-events: auto; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 13px; backdrop-filter: blur(10px); cursor: pointer; }
#bottom-controls { position: fixed; bottom: calc(var(--safe-bottom) + 20px); left: 0; right: 0; height: 90px; display: flex; align-items: center; justify-content: space-around; padding: 0 20px; z-index: 10; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
#shutter { width: 70px; height: 70px; border-radius: 50%; border: 4px solid #fff; background: rgba(255,255,255,0.1); cursor: pointer; transition: transform 0.1s; }
#shutter:active { transform: scale(0.95); }
#menu-trigger, #next-btn, #save-btn, #text-btn, #gif-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px); }
#gif-btn { background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3); border: 2px solid rgba(255,255,255,0.5); font-size: 11px; font-weight: 700; }
#gif-btn.recording { animation: gif-pulse 0.5s ease-in-out infinite; background: #ff3b30; border-color: #fff; }
@keyframes gif-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
#next-btn, #save-btn, #text-btn { display: none; }
#gif-status { position: fixed; top: calc(var(--safe-top) + 70px); left: 50%; transform: translateX(-50%); background: rgba(255,59,48,0.9); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; display: none; z-index: 100; backdrop-filter: blur(10px); }
#gif-status.visible { display: flex; align-items: center; gap: 8px; }
#gif-status::before { content: ''; width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
#bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #1c1c1e; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; max-height: 70vh; display: flex; flex-direction: column; padding-bottom: var(--safe-bottom); }
#bottom-sheet.expanded { transform: translateY(0); }
#sheet-handle { width: 40px; height: 5px; background: rgba(255,255,255,0.3); border-radius: 3px; margin: 12px auto 8px; cursor: grab; }
#sheet-title { text-align: center; font-size: 14px; font-weight: 600; padding: 0 20px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
#tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); background: #1c1c1e; }
.tab { flex: 1; padding: 12px 8px; text-align: center; font-size: 13px; color: rgba(255,255,255,0.6); cursor: pointer; background: none; border: none; border-bottom: 2px solid transparent; }
.tab.active { color: #fff; border-bottom-color: #007aff; }
#tab-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.tab-panel { display: none; padding: 16px; }
.tab-panel.active { display: block; }
.control-group { margin-bottom: 20px; }
.control-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; color: rgba(255,255,255,0.8); }
.control-value { color: #007aff; font-weight: 600; }
input[type="range"] { width: 100%; height: 36px; -webkit-appearance: none; background: transparent; }
input[type="range"]::-webkit-slider-track { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
select { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: #fff; font-size: 14px; }
#preset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
.preset-card { padding: 16px 12px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; text-align: center; position: relative; }
.preset-card.active { background: rgba(0,122,255,0.2); border-color: #007aff; }
.preset-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.preset-desc { font-size: 11px; color: rgba(255,255,255,0.6); }
.btn-secondary { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 12px; }
.divider { height: 1px; background: rgba(255,255,255,0.1); margin: 16px 0; }
.toggle-section { display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 16px; }
.toggle-section input[type="checkbox"] { width: 50px; height: 28px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 14px; position: relative; cursor: pointer; }
.toggle-section input[type="checkbox"]:checked { background: #007aff; }
.toggle-section input[type="checkbox"]::before { content: ''; position: absolute; width: 24px; height: 24px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s; }
.toggle-section input[type="checkbox"]:checked::before { transform: translateX(22px); }
#processing { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 100; font-size: 16px; backdrop-filter: blur(5px); }
#text-modal { position: fixed; bottom: calc(var(--safe-bottom) + 20px); left: 20px; right: 20px; background: #1c1c1e; padding: 20px; border-radius: 16px; display: none; flex-direction: column; gap: 12px; z-index: 60; }
#text-modal input { width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: #fff; font-size: 16px; }
#text-modal .modal-buttons { display: flex; gap: 12px; }
#text-modal .modal-buttons button { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 16px; cursor: pointer; }
#gallery-overlay { position: fixed; inset: 0; background: #000; z-index: 100; display: none; flex-direction: column; padding: var(--safe-top) 0 var(--safe-bottom) 0; }
#gallery-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
#gallery-content { flex: 1; overflow-y: auto; padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
#gallery-content img { width: 100%; border-radius: 8px; aspect-ratio: 3/4; object-fit: cover; }
#camera-selector { position: fixed; bottom: calc(var(--safe-bottom) + 120px); left: 20px; background: rgba(0,0,0,0.8); border-radius: 12px; padding: 12px; display: none; flex-direction: column; gap: 8px; backdrop-filter: blur(10px); z-index: 15; }
.camera-option { padding: 10px 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer; min-width: 150px; }
  </style>
</head>
<body>

<div id="viewfinder-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <img id="photo">
</div>

<div id="top-bar">
  <button id="camera-switch">ðŸ“·</button>
  <button id="gallery-btn">Gallery</button>
</div>

<div id="gif-status">Recording GIF...</div>

<div id="bottom-controls">
  <button id="menu-trigger">â˜°</button>
  <button id="gif-btn" title="Record GIF (no effects)">GIF</button>
  <button id="shutter"></button>
  <button id="save-btn">ðŸ’¾</button>
  <button id="next-btn">â†©</button>
  <button id="text-btn">T</button>
</div>

<div id="bottom-sheet">
  <div id="sheet-handle"></div>
  <div id="sheet-title">Film Controls</div>
  <div id="tabs">
    <button class="tab active" data-tab="presets">Presets</button>
    <button class="tab" data-tab="effects">Effects</button>
  </div>
  <div id="tab-content">
    <div class="tab-panel active" id="presets-panel">
      <div id="preset-grid">
        <div class="preset-card active" data-preset="kodachrome"><div class="preset-name">Kodachrome</div><div class="preset-desc">Classic warm</div></div>
        <div class="preset-card" data-preset="acros"><div class="preset-name">Acros</div><div class="preset-desc">B&W film</div></div>
        <div class="preset-card" data-preset="velvia"><div class="preset-name">Velvia</div><div class="preset-desc">Vibrant colors</div></div>
        <div class="preset-card" data-preset="provia"><div class="preset-name">Provia</div><div class="preset-desc">Natural tones</div></div>
      </div>
      <div class="divider"></div>
      <div id="custom-profiles"></div>
      <button class="btn-secondary" id="save-profile-btn">Save Current as Profile</button>
    </div>
    <div class="tab-panel" id="effects-panel">
      <div class="control-group"><div class="control-label"><span>Exposure</span><span class="control-value" id="exposure-val">0</span></div><input type="range" id="exposure" min="-2" max="2" step="0.1" value="0"></div>
      <div class="divider"></div>
      <div class="control-group"><div class="control-label"><span>Film Grain</span><span class="control-value" id="grain-val">0</span></div><input type="range" id="grain" min="0" max="50" value="0"></div>
      <div class="divider"></div>
      <div class="control-group"><div class="control-label"><span>Vignette</span><span class="control-value" id="vig-val">0</span></div><input type="range" id="vignette" min="0" max="100" value="0"></div>
      <div class="divider"></div>
      <div class="control-group"><div class="control-label"><span>JPEG Quality</span><span class="control-value" id="jpeg-quality-val">60%</span></div><input type="range" id="jpeg-quality" min="20" max="100" value="60"></div>
    </div>
  </div>
</div>

<div id="camera-selector"></div>
<div id="text-modal">
  <input type="text" id="text-input" maxlength="50" placeholder="Enter text for photo">
  <div class="modal-buttons">
    <button id="text-cancel" style="background: rgba(255,255,255,0.1); color: #fff;">Cancel</button>
    <button id="text-submit" style="background: #007aff; color: #fff;">Add Text</button>
  </div>
</div>
<div id="gallery-overlay">
  <div id="gallery-header">
    <h2 style="font-size: 18px; font-weight: 600;">Gallery</h2>
    <button id="gallery-close" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 13px;">Close</button>
  </div>
  <div id="gallery-content"></div>
</div>
<div id="processing"><div style="text-align: center;"><div style="font-size: 16px; margin-bottom: 8px;">Processing...</div><div style="font-size: 13px; opacity: 0.7;" id="processing-text">Applying film simulation</div></div></div>
<select id="cameraSelect" style="display:none"></select>

<script>
const GIF_WORKER_URL = 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js';
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const shutter = document.getElementById('shutter');
const saveBtn = document.getElementById('save-btn');
const nextBtn = document.getElementById('next-btn');
const textBtn = document.getElementById('text-btn');
const gifBtn = document.getElementById('gif-btn');
const gifStatus = document.getElementById('gif-status');
const processingEl = document.getElementById('processing');
const processingText = document.getElementById('processing-text');
const cameraSelect = document.getElementById('cameraSelect');
const bottomSheet = document.getElementById('bottom-sheet');
const menuTrigger = document.getElementById('menu-trigger');

let stream = null, grainAmt = 0, film = 'kodachrome', jpegQ = 60, userText = '', dim = null, lastFrameImageData = null;
let exposureComp = 0, vignetteAmt = 0;
let gifRecording = false, gifFrames = [];
const GIF_FRAME_COUNT = 8, GIF_FRAME_DELAY = 100;

// GIF Recording
gifBtn.addEventListener('click', () => { gifRecording ? stopGifRecording() : startGifRecording(); });

function startGifRecording() {
  if (!video.videoWidth) { alert('Wait for camera'); return; }
  gifRecording = true; gifFrames = [];
  gifBtn.classList.add('recording'); gifBtn.textContent = 'â¹';
  gifStatus.classList.add('visible');
  let frameCount = 0;
  const interval = setInterval(() => {
    if (!gifRecording || frameCount >= GIF_FRAME_COUNT) { clearInterval(interval); if (gifRecording) stopGifRecording(); return; }
    const tmp = document.createElement('canvas');
    tmp.width = video.videoWidth * 0.5; tmp.height = video.videoHeight * 0.5;
    tmp.getContext('2d').drawImage(video, 0, 0, tmp.width, tmp.height);
    gifFrames.push(tmp);
    frameCount++;
    gifStatus.textContent = `Recording... ${frameCount}/${GIF_FRAME_COUNT}`;
  }, GIF_FRAME_DELAY);
}

function stopGifRecording() {
  gifRecording = false;
  gifBtn.classList.remove('recording'); gifBtn.textContent = 'GIF';
  gifStatus.classList.remove('visible');
  if (gifFrames.length < 2) { alert('Not enough frames'); return; }
  processingEl.style.display = 'flex'; processingText.textContent = 'Creating GIF...';
  const gif = new GIF({ workers: 2, quality: 10, width: gifFrames[0].width, height: gifFrames[0].height, workerScript: GIF_WORKER_URL });
  gifFrames.forEach(f => gif.addFrame(f, { delay: 100, copy: true }));
  gif.on('finished', blob => {
    processingEl.style.display = 'none';
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `gif-${Date.now()}.gif`; a.click();
    const reader = new FileReader(); reader.onloadend = () => localStorage.setItem(`saved-gif-${Date.now()}`, reader.result); reader.readAsDataURL(blob);
    gifFrames = [];
  });
  gif.on('progress', p => { processingText.textContent = `Creating GIF... ${Math.round(p * 100)}%`; });
  gif.render();
}

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab + '-panel').classList.add('active');
  });
});

// Bottom sheet
let sheetExpanded = false;
menuTrigger.addEventListener('click', e => { e.stopPropagation(); sheetExpanded = !sheetExpanded; bottomSheet.classList.toggle('expanded', sheetExpanded); });
document.addEventListener('click', e => { if (sheetExpanded && !bottomSheet.contains(e.target) && e.target !== menuTrigger) { sheetExpanded = false; bottomSheet.classList.remove('expanded'); } });

// Presets
document.querySelectorAll('.preset-card').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active'); film = card.dataset.preset;
    if (lastFrameImageData) shootReprocess();
  });
});

// Sliders
const exposureSlider = document.getElementById('exposure'), exposureVal = document.getElementById('exposure-val');
exposureSlider.addEventListener('input', () => { exposureComp = +exposureSlider.value; exposureVal.textContent = exposureComp > 0 ? '+' + exposureComp.toFixed(1) : exposureComp.toFixed(1); if (lastFrameImageData) shootReprocess(); });

const grainSlider = document.getElementById('grain'), grainVal = document.getElementById('grain-val');
grainSlider.addEventListener('input', () => { grainAmt = +grainSlider.value; grainVal.textContent = grainAmt; if (lastFrameImageData) shootReprocess(); });

const vignetteSlider = document.getElementById('vignette'), vigVal = document.getElementById('vig-val');
vignetteSlider.addEventListener('input', () => { vignetteAmt = +vignetteSlider.value; vigVal.textContent = vignetteAmt; if (lastFrameImageData) shootReprocess(); });

const jpegSlider = document.getElementById('jpeg-quality'), jpegVal = document.getElementById('jpeg-quality-val');
jpegSlider.addEventListener('input', () => { jpegQ = +jpegSlider.value; jpegVal.textContent = jpegQ + '%'; });

// Camera
async function bootCam(id = null) {
  if (stream) stream.getTracks().forEach(t => t.stop());
  try { stream = await navigator.mediaDevices.getUserMedia({ video: id ? { deviceId: { exact: id } } : { facingMode: { ideal: 'environment' } } }); video.srcObject = stream; await video.play(); await updateCameraList(); }
  catch (e) { alert('Camera error: ' + e.message); }
}

async function updateCameraList() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  cameraSelect.innerHTML = '';
  devices.filter(d => d.kind === 'videoinput').forEach((d, i) => { const opt = document.createElement('option'); opt.value = d.deviceId; opt.textContent = d.label || `Camera ${i+1}`; cameraSelect.appendChild(opt); });
}

document.getElementById('camera-switch').addEventListener('click', () => {
  const selector = document.getElementById('camera-selector');
  if (selector.style.display === 'flex') { selector.style.display = 'none'; return; }
  selector.innerHTML = '';
  Array.from(cameraSelect.options).forEach(opt => {
    const btn = document.createElement('div'); btn.className = 'camera-option'; btn.textContent = opt.textContent;
    btn.addEventListener('click', () => { bootCam(opt.value); selector.style.display = 'none'; });
    selector.appendChild(btn);
  });
  selector.style.display = 'flex';
});

// Worker
const workerSrc = `
self.onmessage = e => {
  const { imageData, film, grainAmt, exposureComp, vignetteAmt } = e.data;
  const d = imageData.data, W = imageData.width, H = imageData.height;
  const cx = W * 0.5, cy = H * 0.5, maxDist = Math.sqrt(cx * cx + cy * cy);
  for (let y = 0; y < H; y++) {
    for (let x = 0; x < W; x++) {
      const i = (y * W + x) * 4;
      let r = d[i], g = d[i+1], b = d[i+2];
      if (exposureComp !== 0) { const m = Math.pow(2, exposureComp); r = Math.min(255, r * m); g = Math.min(255, g * m); b = Math.min(255, b * m); }
      if (film === 'acros') { const a = (r + g + b) / 3; r = g = b = a; } else { const a = (r + g + b) / 3; r = r * 0.85 + a * 0.15; g = g * 0.85 + a * 0.15; b = b * 0.85 + a * 0.15; }
      if (grainAmt > 0) { const n = (Math.random() - 0.5) * grainAmt * 0.5; r += n; g += n; b += n; }
      if (vignetteAmt > 0) { const dist = Math.sqrt((x - cx) ** 2 + (y - cy) ** 2) / maxDist; const v = 1 - (vignetteAmt / 100) * dist * dist; r *= v; g *= v; b *= v; }
      d[i] = Math.max(0, Math.min(255, r)); d[i+1] = Math.max(0, Math.min(255, g)); d[i+2] = Math.max(0, Math.min(255, b));
    }
  }
  self.postMessage({ imageData }, [imageData.data.buffer]);
};`;
const worker = new Worker(URL.createObjectURL(new Blob([workerSrc], { type: 'application/javascript' })));

// Shoot
shutter.addEventListener('click', () => { userText = ''; shoot(); });

function shoot() {
  if (!video.videoWidth) { alert('Wait for camera'); return; }
  const w = video.videoWidth, h = video.videoHeight, b = Math.floor(Math.min(w, h) * 0.09);
  const fw = w + b * 2, bot = b * 2, fh = h + b + bot;
  canvas.width = fw; canvas.height = fh; dim = { fw, fh, b, bot };
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, fw, fh); ctx.drawImage(video, b, b, w, h);
  canvas.style.display = 'block'; video.style.display = 'none';
  nextBtn.style.display = 'flex'; textBtn.style.display = 'flex'; saveBtn.style.display = 'flex';
  sheetExpanded = false; bottomSheet.classList.remove('expanded');
  const roi = ctx.getImageData(b, b, w, h);
  processingEl.style.display = 'flex'; processingText.textContent = 'Applying film simulation';
  worker.postMessage({ imageData: roi, film, grainAmt, exposureComp, vignetteAmt }, [roi.data.buffer]);
  worker.onmessage = e => { ctx.putImageData(e.data.imageData, b, b); lastFrameImageData = ctx.getImageData(0, 0, fw, fh); drawText(ctx); processingEl.style.display = 'none'; };
}

function shootReprocess() {
  if (!dim) return;
  const { fw, fh, b, bot } = dim, ctx = canvas.getContext('2d', { willReadFrequently: true });
  const roi = ctx.getImageData(b, b, canvas.width - b * 2, canvas.height - b * 2 - (bot - b));
  processingEl.style.display = 'flex';
  worker.postMessage({ imageData: roi, film, grainAmt, exposureComp, vignetteAmt }, [roi.data.buffer]);
  worker.onmessage = e => { ctx.putImageData(e.data.imageData, b, b); lastFrameImageData = ctx.getImageData(0, 0, fw, fh); drawText(ctx); processingEl.style.display = 'none'; };
}

// Text
const textModal = document.getElementById('text-modal'), textInput = document.getElementById('text-input');
textBtn.addEventListener('click', () => { textModal.style.display = 'flex'; textInput.focus(); });
document.getElementById('text-cancel').addEventListener('click', () => { textModal.style.display = 'none'; textInput.value = ''; });
document.getElementById('text-submit').addEventListener('click', async () => { userText = textInput.value.trim(); if (userText) { await document.fonts?.load('131px "Mrs Saint Delafield"').catch(() => {}); updateText(); } textModal.style.display = 'none'; textInput.value = ''; });

function updateText() { if (!dim) return; const ctx = canvas.getContext('2d'); if (lastFrameImageData) ctx.putImageData(lastFrameImageData, 0, 0); drawText(ctx); }

function drawText(ctx) {
  if (!userText || !dim) return;
  const { fw, fh, bot } = dim;
  let fs = 131; ctx.font = `${fs}px "Mrs Saint Delafield", cursive`;
  while (ctx.measureText(userText).width > fw - 20 && fs > 16) { fs--; ctx.font = `${fs}px "Mrs Saint Delafield", cursive`; }
  ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(userText, fw / 2, fh - bot / 2);
}

// Reset
nextBtn.addEventListener('click', () => { video.style.display = 'block'; canvas.style.display = 'none'; nextBtn.style.display = 'none'; textBtn.style.display = 'none'; saveBtn.style.display = 'none'; lastFrameImageData = null; dim = null; userText = ''; });

// Save
saveBtn.addEventListener('click', () => {
  if (!dim) { alert('Take a photo first'); return; }
  const { fw, fh } = dim, scale = 0.4, tmp = document.createElement('canvas');
  tmp.width = Math.floor(fw * scale); tmp.height = Math.floor(fh * scale);
  tmp.getContext('2d').drawImage(canvas, 0, 0, tmp.width, tmp.height);
  tmp.toBlob(blob => {
    if (!blob) { alert('Save failed'); return; }
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `photo-${Date.now()}.jpg`; a.click();
    const fr = new FileReader(); fr.onloadend = () => localStorage.setItem(`saved-photo-${Date.now()}`, fr.result); fr.readAsDataURL(blob);
  }, 'image/jpeg', jpegQ / 100);
});

// Gallery
document.getElementById('gallery-btn').addEventListener('click', () => {
  const content = document.getElementById('gallery-content'); content.innerHTML = '';
  const keys = Object.keys(localStorage).filter(k => k.startsWith('saved-photo-') || k.startsWith('saved-gif-')).sort().reverse();
  if (!keys.length) content.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center; padding: 40px;">No saved images</p>';
  else keys.forEach(k => { const img = document.createElement('img'); img.src = localStorage.getItem(k); content.appendChild(img); });
  document.getElementById('gallery-overlay').style.display = 'flex';
});
document.getElementById('gallery-close').addEventListener('click', () => { document.getElementById('gallery-overlay').style.display = 'none'; });

// Profiles
const PROFILE_KEY = 'filmProfilesV1'; let profiles = {};
function loadProfiles() { try { profiles = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {}; } catch {} renderProfiles(); }
function renderProfiles() {
  const container = document.getElementById('custom-profiles'); container.innerHTML = '';
  Object.keys(profiles).forEach(name => {
    const card = document.createElement('div'); card.className = 'preset-card';
    card.innerHTML = `<div class="preset-name">${name}</div><div class="preset-desc">Custom profile</div>`;
    card.addEventListener('click', () => { document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active')); card.classList.add('active'); applyProfile(name); });
    container.appendChild(card);
  });
}
function applyProfile(name) { const p = profiles[name]; if (!p) return; film = p.filmBase || 'kodachrome'; grainAmt = p.grainAmt || 0; exposureComp = p.exposureComp || 0; vignetteAmt = p.vignetteAmt || 0; exposureSlider.value = exposureComp; grainSlider.value = grainAmt; vignetteSlider.value = vignetteAmt; exposureVal.textContent = exposureComp.toFixed(1); grainVal.textContent = grainAmt; vigVal.textContent = vignetteAmt; if (lastFrameImageData) shootReprocess(); }
document.getElementById('save-profile-btn').addEventListener('click', () => { const name = prompt('Profile name?'); if (!name) return; profiles[name] = { filmBase: film, grainAmt, exposureComp, vignetteAmt }; localStorage.setItem(PROFILE_KEY, JSON.stringify(profiles)); renderProfiles(); alert('Profile saved: ' + name); });

loadProfiles();
bootCam();
document.addEventListener('contextmenu', e => { if (e.target.id !== 'photo') e.preventDefault(); }, { passive: false });
</script>
</body>
</html>
