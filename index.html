<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera PWA – Film App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mrs+Saint+Delafield&display=swap">
  <style>
    body{margin:0;background:#000;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;overflow:hidden}
    video,img{width:100%;max-width:480px;aspect-ratio:3/4;object-fit:contain;background:#000}
    #menu-exit-btn,#gallery-btn{padding:8px;font-size:16px;border:1px solid #fff;border-radius:6px;background:rgba(255,255,255,.2);color:#fff;cursor:pointer}
    #shutter{position:fixed;right:20px;bottom:50%;transform:translateY(50%);width:70px;height:70px;border-radius:50%;border:4px solid #fff;background:rgba(255,255,255,.1);cursor:pointer;z-index:10}
    #save-btn{position:fixed;right:20px;top:calc(25% + 50px);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer;z-index:12}
    #menu-btn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:26px;text-align:center;line-height:44px;backdrop-filter:blur(6px);cursor:pointer;z-index:11}
    #next-btn{position:fixed;right:20px;top:25%;transform:translateY(-50%);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;cursor:pointer;display:none;z-index:12}
    #cameraRadialTrigger{position:fixed;left:10px;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:24px;text-align:center;line-height:44px;cursor:pointer;z-index:20;backdrop-filter:blur(6px);user-select:none;-webkit-user-select:none}
    #cameraRadialMenu{position:fixed;left:44px;top:50%;width:200px;height:200px;margin-left:-20px;margin-top:-100px;pointer-events:none;z-index:21}
    .camera-option{position:absolute;background:rgba(255,255,255,.15);border:1px solid #fff;color:#fff;padding:6px 12px;border-radius:6px;font-size:14px;cursor:pointer;white-space:nowrap;pointer-events:auto;transform:translate(-50%,-50%);transition:background .2s;transform-origin:left center}
    #controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%) translateY(100%);background:rgba(0,0,0,.85);padding:12px;border-radius:10px;transition:.3s ease;opacity:0;pointer-events:none;display:flex;flex-direction:column;gap:10px;width:calc(100% - 32px);max-width:480px;z-index:20}
    #photo{user-select:auto;-webkit-user-select:auto;pointer-events:auto}
    #controls.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
    input[type=range],select{width:100%}
    label{font-size:14px}
    #cameraSelect{position:fixed;top:12px;left:12px;z-index:15;background:rgba(0,0,0,.7);color:#fff;border:1px solid #fff;border-radius:6px;padding:4px;font-size:16px}
    *{user-select:none;-webkit-user-select:none}
    #text-btn{position:fixed;right:20px;bottom:calc(50% + 80px);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer;z-index:12}
    #text-input-modal{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);padding:12px;border-radius:10px;display:flex;gap:10px;width:calc(100% - 32px);max-width:480px;z-index:25}
    #text-input{flex:1;padding:6px;border:1px solid #fff;border-radius:4px;background:rgba(255,255,255,.1);color:#fff;font-size:16px;user-select:auto;-webkit-user-select:auto}
    #text-submit,#text-cancel{padding:6px 12px;border:1px solid #fff;border-radius:4px;background:rgba(255,255,255,.2);color:#fff;cursor:pointer}
  </style>
</head>
<body>

<select id="cameraSelect"></select>
<video id="video" autoplay playsinline></video>
<img id="photo" style="display:none">
<canvas id="canvas" style="display:none"></canvas>

<div id="menu-btn">☰</div>
<div id="next-btn">↩ Next</div>
<button id="save-btn" style="display:none">Save</button>
<button id="shutter"></button>
<div id="cameraRadialTrigger"></div>
<div id="cameraRadialMenu"></div>

<div id="controls">
  <label>Film Simulation
    <select id="film">
      <option value="kodachrome">Kodachrome</option>
      <option value="acros">Acros (Monochrome)</option>
    </select>
  </label>
  <label>JPEG Compression (<span id="jpeg-quality-val">60</span>%)
    <input type="range" id="jpeg-quality" min="20" max="100" value="60">
  </label>
  <label>Film Grain (<span id="grain-val">19</span>)
    <input type="range" id="grain" min="0" max="50" value="19">
  </label>
  <button id="menu-exit-btn">Exit Menu</button>
  <button id="gallery-btn">View Gallery</button>
</div>

<button id="text-btn" style="display:none">TEXT</button>
<div id="text-input-modal" style="display:none">
  <input type="text" id="text-input" maxlength="50" placeholder="Enter text">
  <button id="text-submit">OK</button>
  <button id="text-cancel">Cancel</button>
</div>

<script>
/* ------- DOM refs & state ------- */
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const photo=document.getElementById('photo');
const shutter=document.getElementById('shutter');
const saveBtn=document.getElementById('save-btn');
const nextBtn=document.getElementById('next-btn');
const menuBtn=document.getElementById('menu-btn');
const controls=document.getElementById('controls');
const grainSlider=document.getElementById('grain');
const grainVal=document.getElementById('grain-val');
const filmSelect=document.getElementById('film');
const cameraSelect=document.getElementById('cameraSelect');
const jpegQualitySlider=document.getElementById('jpeg-quality');
const jpegQualityVal=document.getElementById('jpeg-quality-val');
const textBtn=document.getElementById('text-btn');
const textModal=document.getElementById('text-input-modal');
const textInput=document.getElementById('text-input');
const textSubmit=document.getElementById('text-submit');
const textCancel=document.getElementById('text-cancel');

let currentStream=null,grainAmount=+grainSlider.value,film=filmSelect.value,
    jpegQuality=+jpegQualitySlider.value,userText='',processedImageData=null,imageDimensions=null;

/* ------- basic UI ------- */
grainSlider.oninput=()=>{grainAmount=+grainSlider.value;grainVal.textContent=grainAmount};
filmSelect.onchange=()=>{film=filmSelect.value};
jpegQualitySlider.oninput=()=>{jpegQuality=+jpegQualitySlider.value;jpegQualityVal.textContent=jpegQuality};
menuBtn.onclick=()=>controls.classList.toggle('show');
nextBtn.onclick=()=>{video.style.display='block';photo.style.display='none';nextBtn.style.display='none';textBtn.style.display='none';userText='';processedImageData=null;imageDimensions=null};

/* ------- camera ------- */
cameraSelect.onchange=()=>startCamera(cameraSelect.value);
async function startCamera(deviceId=null){
  if(currentStream)currentStream.getTracks().forEach(t=>t.stop());
  const constraints={video:deviceId?{deviceId:{exact:deviceId},width:{ideal:4096},height:{ideal:2160}}:{facingMode:{exact:'environment'},width:{ideal:4096},height:{ideal:2160}}};
  try{
    currentStream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=currentStream;await video.play();await populateCameraOptions();
  }catch(e){alert('Camera Error: '+(e.name==='NotAllowedError'?'Camera access denied':e.message));}
}
async function populateCameraOptions(){
  const vids=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
  cameraSelect.innerHTML='';vids.forEach((d,i)=>{const o=document.createElement('option');o.value=d.deviceId;o.textContent=d.label||`Camera ${i+1}`;cameraSelect.appendChild(o)});
}

/* ------- radial menu (unchanged) ------- */
const cameraRadialTrigger=document.getElementById('cameraRadialTrigger');
const cameraRadialMenu=document.getElementById('cameraRadialMenu');
let radialTimeout=null,radialActive=false,currentHovered=null;
cameraRadialTrigger.addEventListener('pointerdown',()=>{radialTimeout=setTimeout(()=>{showRadial();radialActive=true},300)});
document.addEventListener('pointermove',e=>{
  if(!radialActive)return;
  let closest=null,min=Infinity;
  document.querySelectorAll('.camera-option').forEach(opt=>{
    const r=opt.getBoundingClientRect(),dx=e.clientX-(r.left+r.width/2),dy=e.clientY-(r.top+r.height/2),dist=Math.hypot(dx,dy);
    if(dist<min&&dist<80){min=dist;closest=opt}opt.style.background='rgba(255,255,255,.15)';
  });
  currentHovered=closest;if(closest)closest.style.background='rgba(255,255,255,.4)';
});
document.addEventListener('pointerup',()=>{clearTimeout(radialTimeout);if(radialActive){if(currentHovered){cameraSelect.value=currentHovered.dataset.id;startCamera(currentHovered.dataset.id)}cameraRadialMenu.innerHTML='';radialActive=false}});
function showRadial(){
  cameraRadialMenu.innerHTML='';
  const opts=[...cameraSelect.options],n=opts.length,clamp=Math.max(1,Math.min(7,n)),start=-Math.PI/4,end=Math.PI/4,spread=end-start,r=90+(clamp-1)*6;
  opts.forEach((o,i)=>{const a=start+i*spread/(clamp-1||1),x=Math.cos(a)*r+100,y=Math.sin(a)*r+100,d=document.createElement('div');d.className='camera-option';d.style.left=`${x}px`;d.style.top=`${y}px`;d.textContent=o.textContent;d.dataset.id=o.value;cameraRadialMenu.appendChild(d)});
}

/* ------- text modal ------- */
function showText(){textModal.style.display='flex';textInput.focus()}
function hideText(){textModal.style.display='none';textInput.value=''}
textBtn.onclick=showText;
textSubmit.onclick=()=>{userText=textInput.value.trim();userText&&(processedImageData?updateText():renderPhoto());hideText();}
textCancel.onclick=hideText;
textInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();textSubmit.click()}});

/* ------- capture & render ------- */
shutter.onclick=()=>{userText='';renderPhoto();};
function renderPhoto(){
  if(!video.videoWidth){alert('Video not ready');return;}
  const w=video.videoWidth,h=video.videoHeight,b=Math.floor(Math.min(w,h)*0.09),fw=w+b*2,bot=b*2,fh=h+b+bot;
  canvas.width=fw;canvas.height=fh;imageDimensions={w,h,border:b,finalW:fw,bottomBorder:bot,finalH:fh};
  const ctx=canvas.getContext('2d');ctx.fillStyle='#fff';ctx.fillRect(0,0,fw,fh);ctx.drawImage(video,b,b,w,h);
  const img=ctx.getImageData(b,b,w,h),d=img.data;
  for(let i=0;i<d.length;i+=4){
    let[r,g,bl]=[d[i],d[i+1],d[i+2]];
    if(film==='acros'){const a=(r+g+bl)/3;r=g=bl=a}else if(film==='kodachrome'){const a=(r+g+bl)/3;r=r*.85+a*.15;g=g*.85+a*.15;bl=bl*.85+a*.15}
    if(grainAmount){const n=(Math.random()-0.5)*2*grainAmount;r+=n;g+=n;bl+=n}
    d[i]=Math.max(0,Math.min(255,r));d[i+1]=Math.max(0,Math.min(255,g));d[i+2]=Math.max(0,Math.min(255,bl));
  }
  processedImageData=img;ctx.putImageData(img,b,b);
  if(userText){let fs=131;ctx.font=`${fs}px "Mrs Saint Delafield"`;while(ctx.measureText(userText).width>fw-20&&fs>16){fs--;ctx.font=`${fs}px "Mrs Saint Delafield"`}ctx.fillStyle='#000';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(userText,fw/2,fh-bot/2);}
  photo.src=canvas.toDataURL('image/jpeg',1.0);photo.style.display='block';video.style.display='none';nextBtn.style.display='block';textBtn.style.display='block';saveBtn.style.display='block';
}
function updateText(){
  const{finalW:fw,finalH:fh,bottomBorder:bot,border:b}=imageDimensions;
  canvas.width=fw;canvas.height=fh;
  const ctx=canvas.getContext('2d');ctx.fillStyle='#fff';ctx.fillRect(0,0,fw,fh);ctx.putImageData(processedImageData,b,b);
  let fs=131;ctx.font=`${fs}px "Mrs Saint Delafield"`;while(ctx.measureText(userText).width>fw-20&&fs>16){fs--;ctx.font=`${fs}px "Mrs Saint Delafield"`}ctx.fillStyle='#000';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(userText,fw/2,fh-bot/2);
  photo.src=canvas.toDataURL('image/jpeg',1.0);
}

/* ------- SAVE (await WASM) ------- */
saveBtn.onclick=async()=>{
  if(!processedImageData)return;
  await window.mozjpegReady;
  const{finalW:fw,finalH:fh}=imageDimensions,scale=1810/4420;
  const temp=document.createElement('canvas');temp.width=Math.floor(fw*scale);temp.height=Math.floor(fh*scale);
  temp.getContext('2d').drawImage(canvas,0,0,temp.width,temp.height);
  const blob=await compressCanvasWithMozJPEG(temp,jpegQuality);
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`photo-${Date.now()}.jpg`;a.click();URL.revokeObjectURL(url);
  const r=new FileReader();r.onloadend=()=>localStorage.setItem(`saved-photo-${Date.now()}`,r.result);r.readAsDataURL(blob);
};

/* ------- gallery ------- */
document.getElementById('gallery-btn').onclick=()=>{
  const gal=document.getElementById('gallery-content');gal.innerHTML='';
  const keys=Object.keys(localStorage).filter(k=>k.startsWith('saved-photo-')).sort().reverse();
  if(!keys.length)gal.innerHTML='<p style="color:white;">No saved images.</p>';
  else keys.forEach(k=>{const img=document.createElement('img');img.src=localStorage.getItem(k);img.style.width='100px';gal.appendChild(img);});
  document.getElementById('gallery-overlay').style.display='block';
};
document.getElementById('menu-exit-btn').onclick=()=>controls.classList.remove('show');

/* ------- boot ------- */
startCamera();
</script>

<script>
if('serviceWorker'in navigator){navigator.serviceWorker.register('./service-worker.js').then(reg=>{reg.onupdatefound=()=>{const nw=reg.installing;nw.onstatechange=()=>{if(nw.state==='installed'&&navigator.serviceWorker.controller)alert('New update available! Please refresh.');};};});}
document.addEventListener('contextmenu',e=>{if(e.target.id!=='photo')e.preventDefault();},{passive:false});
</script>

<!-- ------- mozjpeg WASM (global promise) ------- -->
<script type="module">
import init,{encode}from'./lib/mozjpeg/mozjpeg_enc.js';
let res;window.mozjpegReady=new Promise(r=>res=r);
init().then(()=>{
  window.compressCanvasWithMozJPEG=async(c,q)=>{
    const ctx=c.getContext('2d'),img=ctx.getImageData(0,0,c.width,c.height);
    const out=encode(img.data,c.width,c.height,q);
    return new Blob([out.buffer],{type:'image/jpeg'});
  };
  res(); /* resolve */
});
</script>

<div id="gallery-overlay" style="display:none;position:fixed;inset:0;background:#000;z-index:99;overflow:auto;padding:10px">
  <button onclick="this.parentNode.style.display='none'" style="position:fixed;top:10px;right:10px;z-index:100;">Close</button>
  <div id="gallery-content" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:50px"></div>
</div>
</body>
</html>
