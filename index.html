<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera PWA – Film App (Fast)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mrs+Saint+Delafield&display=swap">
  <style>
    /* ---------- SHARED STYLES ---------- */
    body{margin:0;background:#000;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;overflow:hidden}
    html{height:100vh;overflow:hidden}

    video,canvas,#photo{width:100%;max-width:480px;aspect-ratio:3/4;object-fit:contain;background:#000}
    #menu-exit-btn,#gallery-btn,#calibrate-btn,#save-profile-btn{padding:8px;font-size:16px;border:1px solid #fff;border-radius:6px;background:rgba(255,255,255,.2);color:#fff;cursor:pointer}
    #shutter{position:fixed;right:20px;bottom:50%;transform:translateY(50%);width:70px;height:70px;border-radius:50%;border:4px solid #fff;background:rgba(255,255,255,.1);cursor:pointer;z-index:10}
    #save-btn{position:fixed;bottom:20px;left:calc(50% + 100px);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer;z-index:12}
    #menu-btn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:26px;text-align:center;line-height:44px;backdrop-filter:blur(6px);cursor:pointer;z-index:11}
    #next-btn{position:fixed;right:20px;top:25%;transform:translateY(-50%);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;cursor:pointer;display:none;z-index:12}

    /* ---------- RADIAL SELECTOR ---------- */
    #cameraRadialTrigger{position:fixed;left:10px;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:24px;text-align:center;line-height:44px;cursor:pointer;z-index:20;backdrop-filter:blur(6px);user-select:none;-webkit-user-select:none}
    #cameraRadialMenu{position:fixed;left:44px;top:50%;width:200px;height:200px;margin-left:-20px;margin-top:-100px;pointer-events:none;z-index:21}
    .camera-option{position:absolute;background:rgba(255,255,255,.15);border:1px solid #fff;color:#fff;padding:6px 12px;border-radius:6px;font-size:14px;cursor:pointer;white-space:nowrap;pointer-events:auto;transform:translate(-50%,-50%);transition:background .2s}

    /* ---------- MENU (COLLAPSIBLE) ---------- */
    #controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%) translateY(100%);background:rgba(0,0,0,.85);padding:12px;border-radius:10px;transition:.3s ease;opacity:0;pointer-events:none;display:flex;flex-direction:column;gap:10px;width:calc(100% - 32px);max-width:480px;z-index:20;max-height:60vh;overflow:auto}
    #controls.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
    #photo{user-select:auto;-webkit-user-select:auto;pointer-events:auto}
    input[type=range],select{width:100%}
    label{font-size:14px}
    #cameraSelect{position:fixed;top:12px;left:12px;z-index:15;background:rgba(0,0,0,.7);color:#fff;border:1px solid #fff;border-radius:6px;padding:4px;font-size:16px}
    *{user-select:none;-webkit-user-select:none}

    /* ---------- TEXT OVERLAY ---------- */
    #text-btn{position:fixed;bottom:20px;left:calc(50% - 120px);font-size:18px;padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer;z-index:12}
    #text-input-modal{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);padding:12px;border-radius:10px;display:flex;gap:10px;width:calc(100% - 32px);max-width:480px;z-index:25}
    #text-input{flex:1;padding:6px;border:1px solid #fff;border-radius:4px;background:rgba(255,255,255,.1);color:#fff;font-size:16px;user-select:auto;-webkit-user-select:auto}
    #text-submit,#text-cancel{padding:6px 12px;border:1px solid #fff;border-radius:4px;background:rgba(255,255,255,.2);color:#fff;cursor:pointer}

    /* ---------- COLOR MIX UI ---------- */
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{width:26px;height:26px;border-radius:50%;border:2px solid #fff;cursor:pointer;box-shadow:0 0 0 2px rgba(255,255,255,.15) inset}
    .chip.sel{box-shadow:0 0 0 3px #fff inset}
    .small{font-size:12px;opacity:.9}
    .divider{height:1px;background:rgba(255,255,255,.2);margin:4px 0}

    /* ---------- PROCESSING OVERLAY ---------- */
    #processing{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:30;font-size:16px}
    #hint{font-size:12px;opacity:.8}

    /* ---------- Accordion styling ---------- */
    details.acc{border:1px solid rgba(255,255,255,.25);border-radius:8px;overflow:hidden}
    details.acc + details.acc{margin-top:8px}
    details.acc > summary{cursor:pointer;padding:10px 12px;font-weight:600;list-style:none;background:rgba(255,255,255,.08)}
    details.acc[open] > summary{background:rgba(255,255,255,.12)}
    details.acc > .acc-body{padding:10px 12px}
    details.acc summary::-webkit-details-marker{display:none}
  </style>
</head>
<body>

<select id="cameraSelect"></select>
<video id="video" autoplay playsinline></video>
<img id="photo" style="display:none">
<canvas id="canvas" style="display:none"></canvas>
<div id="processing">Processing…</div>

<div id="menu-btn">☰</div>
<div id="next-btn">↩ Next</div>
<button id="save-btn" style="display:none">Save</button>
<button id="shutter"></button>

<!-- radial selector elements -->
<div id="cameraRadialTrigger"></div>
<div id="cameraRadialMenu"></div>

<div id="controls">
  <!-- Film & Output -->
  <details id="acc-film" class="acc">
    <summary>Film & Output</summary>
    <div class="acc-body">
      <label>Film Simulation
        <select id="film">
          <option value="kodachrome">Kodachrome</option>
          <option value="acros">Acros (Monochrome)</option>
        </select>
      </label>
      <label>JPEG Compression (<span id="jpeg-quality-val">60</span>%)
        <input type="range" id="jpeg-quality" min="20" max="100" value="60">
      </label>
    </div>
  </details>

  <!-- Grain -->
  <details id="acc-grain" class="acc">
    <summary>Grain</summary>
    <div class="acc-body">
      <label>Film Grain (<span id="grain-val">19</span>)
        <input type="range" id="grain" min="0" max="50" value="19">
      </label>
    </div>
  </details>

  <!-- Per-Color Adjustments -->
  <details id="acc-cmix" class="acc">
    <summary>Per-Color Adjustments (H/S/L)</summary>
    <div class="acc-body">
      <div class="row">
        <input type="checkbox" id="cm-enable">
        <label for="cm-enable" style="margin:0">Enable Per-Color Adjustments</label>
      </div>
      <div id="cm-wrap" style="display:none">
        <div class="row" id="cm-palette" aria-label="Color buckets"></div>
        <div class="row small"><span id="cm-label">Red</span> &nbsp;|&nbsp; Hue <span id="cm-hv">0</span>° &nbsp; Sat <span id="cm-sv">0</span> &nbsp; Lum <span id="cm-lv">0</span></div>
        <label>Hue Shift (°)
          <input type="range" id="cm-h" min="-30" max="30" value="0">
        </label>
        <label>Saturation (-100…+100)
          <input type="range" id="cm-s" min="-100" max="100" value="0">
        </label>
        <label>Luminance (-100…+100)
          <input type="range" id="cm-l" min="-100" max="100" value="0">
        </label>
        <div class="row">
          <button id="cm-reset" style="padding:6px 10px;background:rgba(255,255,255,.15);border:1px solid #fff;border-radius:6px;color:#fff;cursor:pointer">Reset Color Mix</button>
        </div>
      </div>
    </div>
  </details>

  <!-- Calibration trigger lives outside the collapsed content so it's always visible -->
  <div class="divider"></div>
  <button id="calibrate-btn" title="Capture a calibration shot, then fine-tune">Color Calibration</button>
  <div id="hint" style="display:none;">Calibration armed: snap a photo to open calibration sliders.</div>

  <!-- Calibration (WB / Vignette / Halation) -->
  <details id="acc-calib" class="acc">
    <summary>Calibration (WB / Vignette / Halation)</summary>
    <div class="acc-body">
      <div id="calibration-panel" style="display:none">
        <strong>Calibration</strong>
        <label>White Balance – Red (-8…+8): <span id="wb-r-val">0</span>
          <input type="range" id="wb-r" min="-8" max="8" value="0">
        </label>
        <label>White Balance – Blue (-8…+8): <span id="wb-b-val">0</span>
          <input type="range" id="wb-b" min="-8" max="8" value="0">
        </label>
        <label>Vignette (0…100): <span id="vig-val">0</span>
          <input type="range" id="vignette" min="0" max="100" value="0">
        </label>

        <div class="divider"></div>
        <strong>Halation</strong>
        <div class="row">
          <input type="checkbox" id="hal-enable">
          <label for="hal-enable" style="margin:0">Enable Halation</label>
        </div>
        <label>Amount (0…100): <span id="hal-amt-val">25</span>
          <input type="range" id="hal-amt" min="0" max="100" value="25">
        </label>
        <label>Threshold (0…100): <span id="hal-thr-val">80</span>
          <input type="range" id="hal-thr" min="0" max="100" value="80">
        </label>
        <label>Spread (px 1…40): <span id="hal-spread-val">12</span>
          <input type="range" id="hal-spread" min="1" max="40" value="12">
        </label>
        <label>Tone (Hue 0…360°): <span id="hal-tone-val">15</span>
          <input type="range" id="hal-tone" min="0" max="360" value="15">
        </label>

        <div class="row">
          <button id="save-profile-btn" title="Save current mix + WB + grain + vignette + halation as a profile">Save as Film Profile</button>
        </div>
      </div>
    </div>
  </details>

  <!-- Exit / Gallery -->
  <div class="row" style="justify-content:space-between">
    <button id="menu-exit-btn">Exit Menu</button>
    <button id="gallery-btn">View Gallery</button>
  </div>
</div>

<button id="text-btn" style="display:none">TEXT</button>
<div id="text-input-modal" style="display:none">
  <input type="text" id="text-input" maxlength="50" placeholder="Enter text">
  <button id="text-submit">OK</button>
  <button id="text-cancel">Cancel</button>
</div>

<script>
/* ---------- DOM refs & state ---------- */
const video        = document.getElementById('video');
const canvas       = document.getElementById('canvas');
const photo        = document.getElementById('photo');
const processingEl = document.getElementById('processing');
const shutter      = document.getElementById('shutter');
const saveBtn      = document.getElementById('save-btn');
const nextBtn      = document.getElementById('next-btn');
const menuBtn      = document.getElementById('menu-btn');
const controls     = document.getElementById('controls');
const grainSlider  = document.getElementById('grain');
const grainVal     = document.getElementById('grain-val');
const filmSelect   = document.getElementById('film');
const cameraSelect = document.getElementById('cameraSelect');
const jpegSlider   = document.getElementById('jpeg-quality');
const jpegVal      = document.getElementById('jpeg-quality-val');
const textBtn      = document.getElementById('text-btn');
const textModal    = document.getElementById('text-input-modal');
const textInput    = document.getElementById('text-input');
const textSubmit   = document.getElementById('text-submit');
const textCancel   = document.getElementById('text-cancel');

const calibrateBtn = document.getElementById('calibrate-btn');
const accCalib     = document.getElementById('acc-calib');
const calibrationPanel = document.getElementById('calibration-panel');
const hintEl = document.getElementById('hint');
const wbRSlider = document.getElementById('wb-r');
const wbBSlider = document.getElementById('wb-b');
const wbRVal = document.getElementById('wb-r-val');
const wbBVal = document.getElementById('wb-b-val');
const vignetteSlider = document.getElementById('vignette');
const vigVal = document.getElementById('vig-val');
const saveProfileBtn = document.getElementById('save-profile-btn');

/* Halation refs */
const halEnable = document.getElementById('hal-enable');
const halAmt = document.getElementById('hal-amt');
const halThr = document.getElementById('hal-thr');
const halSpread = document.getElementById('hal-spread');
const halTone = document.getElementById('hal-tone');
const halAmtVal = document.getElementById('hal-amt-val');
const halThrVal = document.getElementById('hal-thr-val');
const halSpreadVal = document.getElementById('hal-spread-val');
const halToneVal = document.getElementById('hal-tone-val');

/* ----- radial selector refs ----- */
const cameraRadialTrigger = document.getElementById('cameraRadialTrigger');
const cameraRadialMenu    = document.getElementById('cameraRadialMenu');

/* ----- Color Mix refs ----- */
const cmEnable = document.getElementById('cm-enable');
const cmWrap   = document.getElementById('cm-wrap');
const cmPalette= document.getElementById('cm-palette');
const cmH      = document.getElementById('cm-h');
const cmS      = document.getElementById('cm-s');
const cmL      = document.getElementById('cm-l');
const cmHV     = document.getElementById('cm-hv');
const cmSV     = document.getElementById('cm-sv');
const cmLV     = document.getElementById('cm-lv');
const cmLabel  = document.getElementById('cm-label');
const cmReset  = document.getElementById('cm-reset');

/* ---------- helpers ---------- */
function lockScroll(){
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
  window.scrollTo(0,0);
}

/* ---------- state ---------- */
let stream   = null,
    grainAmt = +grainSlider.value,
    film     = filmSelect.value,
    jpegQ    = +jpegSlider.value,
    userText = '',
    dim      = null,
    lastFrameImageData = null;

/* ---------- Calibration state ---------- */
let calibrationArmed = false;
let activeProfileName = null;

const PROFILE_KEY = 'filmProfilesV1';
let profiles = {};

/* ---------- COLOR MIX state ---------- */
const CM_KEY = 'colorMixSettingsV1';
const colors = [
  {name:'Red',     css:'#ff3b30', center:0.00},
  {name:'Orange',  css:'#ff9500', center:0.06},
  {name:'Yellow',  css:'#ffcc00', center:0.12},
  {name:'Green',   css:'#34c759', center:0.33},
  {name:'Aqua',    css:'#32d7d7', center:0.50},
  {name:'Blue',    css:'#007aff', center:0.62},
  {name:'Purple',  css:'#9b59ff', center:0.75},
  {name:'Magenta', css:'#ff2d7a', center:0.88},
];
const hueWidth = [0.09,0.10,0.08,0.07,0.06,0.07,0.07,0.08];
let cmIdx = 0;

let cmState = { enable:false, dH:new Array(8).fill(0), dS:new Array(8).fill(0), dL:new Array(8).fill(0) };
try{
  const saved = JSON.parse(localStorage.getItem(CM_KEY));
  if (saved && Array.isArray(saved.dH) && Array.isArray(saved.dS) && Array.isArray(saved.dL)){
    cmState = { enable: !!saved.enable, dH: saved.dH, dS: saved.dS, dL: saved.dL };
  }
}catch{}

/* ---------- WB/Vignette state ---------- */
const WB_KEY = 'wbSettingsV1';
let wb = { r:0, b:0 };
let vignetteAmt = 0;
try{ const savedWB = JSON.parse(localStorage.getItem(WB_KEY)); if (savedWB) wb = savedWB; }catch{}
try{ const savedVig = +localStorage.getItem('vignetteAmtV1'); if (!isNaN(savedVig)) vignetteAmt = savedVig; }catch{}

/* ---------- Halation state ---------- */
const HAL_KEY = 'halationSettingsV1';
let hal = { enable:false, amount:25, threshold:80, spread:12, tone:15 }; // tone hue deg
try{
  const savedH = JSON.parse(localStorage.getItem(HAL_KEY));
  if (savedH && typeof savedH === 'object') hal = Object.assign(hal, savedH);
}catch{}

/* ---------- UI wiring ---------- */
grainSlider.oninput = () => { grainAmt = +grainSlider.value; grainVal.textContent = grainAmt; if (lastFrameImageData) shootReprocess(); };
filmSelect.onchange = () => {
  const v = filmSelect.value;
  if (v.startsWith('profile:')){ activeProfileName = v.slice(8); applyProfileToUI(activeProfileName); }
  else { activeProfileName = null; film = v; if (lastFrameImageData) shootReprocess(); }
};
jpegSlider.oninput  = () => { jpegQ  = +jpegSlider.value; jpegVal.textContent = jpegQ; };
menuBtn.onclick     = () => controls.classList.toggle('show');

/* Color Mix */
function buildPalette(){
  cmPalette.innerHTML = '';
  colors.forEach((c, i) => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (i===cmIdx ? ' sel':'');
    chip.style.background = c.css;
    chip.title = c.name;
    chip.addEventListener('click', () => { cmIdx = i; refreshCmControls(); buildPalette(); if (lastFrameImageData) shootReprocess(); });
    cmPalette.appendChild(chip);
  });
}
function refreshCmControls(){
  cmEnable.checked = cmState.enable;
  cmWrap.style.display = cmState.enable ? 'block' : 'none';
  cmLabel.textContent = colors[cmIdx].name;
  cmH.value = Math.round((cmState.dH[cmIdx] || 0) * 360);
  cmS.value = Math.round((cmState.dS[cmIdx] || 0) * 200);
  cmL.value = Math.round((cmState.dL[cmIdx] || 0) * 200);
  cmHV.textContent = cmH.value;
  cmSV.textContent = cmS.value;
  cmLV.textContent = cmL.value;
}
function saveCmState(){ localStorage.setItem(CM_KEY, JSON.stringify(cmState)); }
cmEnable.addEventListener('change', () => { cmState.enable = cmEnable.checked; saveCmState(); refreshCmControls(); if (lastFrameImageData) shootReprocess(); });
cmH.addEventListener('input', () => { cmState.dH[cmIdx] = (+cmH.value)/360; cmHV.textContent = cmH.value; saveCmState(); if (lastFrameImageData) shootReprocess(); });
cmS.addEventListener('input', () => { cmState.dS[cmIdx] = (+cmS.value)/200; cmSV.textContent = cmS.value; saveCmState(); if (lastFrameImageData) shootReprocess(); });
cmL.addEventListener('input', () => { cmState.dL[cmIdx] = (+cmL.value)/200; cmLV.textContent = cmL.value; saveCmState(); if (lastFrameImageData) shootReprocess(); });
cmReset.addEventListener('click', () => { cmState.dH.fill(0); cmState.dS.fill(0); cmState.dL.fill(0); saveCmState(); refreshCmControls(); if (lastFrameImageData) shootReprocess(); });
buildPalette(); refreshCmControls();

/* Calibration wiring */
function refreshWBUI(){ wbRSlider.value = wb.r; wbBSlider.value = wb.b; wbRVal.textContent = wb.r; wbBVal.textContent = wb.b; }
function refreshVignetteUI(){ vignetteSlider.value = vignetteAmt; vigVal.textContent = vignetteAmt; }
function refreshHalUI(){
  halEnable.checked = !!hal.enable;
  halAmt.value = hal.amount; halAmtVal.textContent = hal.amount;
  halThr.value = hal.threshold; halThrVal.textContent = hal.threshold;
  halSpread.value = hal.spread; halSpreadVal.textContent = hal.spread;
  halTone.value = hal.tone; halToneVal.textContent = hal.tone;
}
function saveWB(){ localStorage.setItem(WB_KEY, JSON.stringify(wb)); }
function saveVignette(){ localStorage.setItem('vignetteAmtV1', String(vignetteAmt)); }
function saveHal(){ localStorage.setItem(HAL_KEY, JSON.stringify(hal)); }

wbRSlider.oninput = () => { wb.r = +wbRSlider.value; wbRVal.textContent = wb.r; saveWB(); if (lastFrameImageData) shootReprocess(); };
wbBSlider.oninput = () => { wb.b = +wbBSlider.value; wbBVal.textContent = wb.b; saveWB(); if (lastFrameImageData) shootReprocess(); };
vignetteSlider.oninput = () => { vignetteAmt = +vignetteSlider.value; vigVal.textContent = vignetteAmt; saveVignette(); if (lastFrameImageData) shootReprocess(); };

halEnable.onchange = () => { hal.enable = halEnable.checked; saveHal(); if (lastFrameImageData) shootReprocess(); };
halAmt.oninput = () => { hal.amount = +halAmt.value; halAmtVal.textContent = hal.amount; saveHal(); if (lastFrameImageData) shootReprocess(); };
halThr.oninput = () => { hal.threshold = +halThr.value; halThrVal.textContent = hal.threshold; saveHal(); if (lastFrameImageData) shootReprocess(); };
halSpread.oninput = () => { hal.spread = +halSpread.value; halSpreadVal.textContent = hal.spread; saveHal(); if (lastFrameImageData) shootReprocess(); };
halTone.oninput = () => { hal.tone = +halTone.value; halToneVal.textContent = hal.tone; saveHal(); if (lastFrameImageData) shootReprocess(); };

calibrateBtn.onclick = () => {
  calibrationArmed = true;
  hintEl.style.display = 'block';
  controls.classList.remove('show');
  cmState.enable = true; saveCmState(); refreshCmControls();
};

function openCalibrationPanel(){
  controls.classList.add('show');
  accCalib.open = true;                          // auto-expand accordion
  calibrationPanel.style.display = 'block';
  hintEl.style.display = 'none';
  refreshWBUI(); refreshVignetteUI(); refreshHalUI();
}

saveProfileBtn.onclick = () => {
  const name = (prompt('Profile name?') || '').trim();
  if (!name) return;
  const settings = {
    filmBase: filmSelect.value.startsWith('profile:') ? 'kodachrome' : filmSelect.value,
    cmState,
    grainAmt,
    wb,
    vignetteAmt,
    hal
  };
  profiles[name] = settings;
  localStorage.setItem(PROFILE_KEY, JSON.stringify(profiles));
  populateProfiles();
  filmSelect.value = 'profile:' + name;
  activeProfileName = name;
  alert('Saved profile: ' + name);
};

/* Profiles */
function populateProfiles(){
  let group = filmSelect.querySelector('optgroup[label="Custom Profiles"]');
  if (!group){ group = document.createElement('optgroup'); group.label = 'Custom Profiles'; filmSelect.appendChild(group); }
  group.innerHTML = '';
  Object.keys(profiles).forEach(name => {
    const opt = document.createElement('option');
    opt.value = 'profile:' + name;
    opt.textContent = 'Profile: ' + name;
    group.appendChild(opt);
  });
}
function loadProfiles(){
  try{ const raw = JSON.parse(localStorage.getItem(PROFILE_KEY)); if (raw && typeof raw==='object') profiles = raw; }catch{}
  populateProfiles();
}
function applyProfileToUI(name){
  const p = profiles[name]; if (!p) return;
  film = p.filmBase || 'kodachrome';

  grainAmt = typeof p.grainAmt === 'number' ? p.grainAmt : grainAmt;
  grainSlider.value = grainAmt; grainVal.textContent = grainAmt;

  if (p.cmState){ cmState = JSON.parse(JSON.stringify(p.cmState)); saveCmState(); refreshCmControls(); buildPalette(); }
  if (p.wb){ wb = { r: p.wb.r|0, b: p.wb.b|0 }; saveWB(); refreshWBUI(); }
  if (typeof p.vignetteAmt === 'number'){ vignetteAmt = p.vignetteAmt|0; saveVignette(); refreshVignetteUI(); }
  if (p.hal){ hal = Object.assign({ enable:false, amount:25, threshold:80, spread:12, tone:15 }, p.hal); saveHal(); refreshHalUI(); }

  if (lastFrameImageData) shootReprocess();
}

/* ---------- NEXT / MENU ---------- */
nextBtn.onclick = () => {
  document.documentElement.style.overflow = 'hidden';
  document.body.style.position  = 'fixed';
  document.body.style.width     = '100%';
  window.scrollTo(0, 0);
  lockScroll();
  video.style.display   = 'block';
  canvas.style.display  = 'none';
  photo.style.display   = 'none';
  nextBtn.style.display = 'none';
  textBtn.style.display = 'none';
  saveBtn.style.display = 'none';
  lastFrameImageData = null;
  dim = null;
  userText = '';
  hintEl.style.display = 'none';
  calibrationPanel.style.display = 'none';
  calibrationArmed = false;
};

/* ---------- camera core ---------- */
cameraSelect.onchange = () => bootCam(cameraSelect.value);

async function bootCam(id = null){
  if (stream) stream.getTracks().forEach(t => t.stop());
  const c = { video: id
                ? { deviceId:{exact:id}, width:{ideal:1920}, height:{ideal:1080} }
                : { facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} } };
  try{
    stream = await navigator.mediaDevices.getUserMedia(c);
    video.srcObject = stream;
    await video.play();
    await cams();
  }catch(e){ alert('Camera error: ' + e.message); }
}
async function cams(){
  const v = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput');
  const current = cameraSelect.value;
  cameraSelect.innerHTML = '';
  v.forEach((d,i) => {
    const o = document.createElement('option');
    o.value = d.deviceId;
    o.textContent = d.label || `Camera ${i+1}`;
    cameraSelect.appendChild(o);
  });
  if (current) cameraSelect.value = current;
}

/* ---------- radial-selector logic ---------- */
let radialTimeout = null;
let radialActive  = false;
let currentHoveredOpt = null;

cameraRadialTrigger.addEventListener('pointerdown', () => {
  radialTimeout = setTimeout(() => { showCameraRadialMenu(); radialActive = true; }, 300);
});
document.addEventListener('pointermove', e => {
  if (!radialActive) return;
  const opts = document.querySelectorAll('.camera-option');
  let closest = null, minDist = Infinity;
  opts.forEach(opt => {
    const r  = opt.getBoundingClientRect();
    const cx = r.left + r.width/2, cy = r.top + r.height/2;
    const dx = e.clientX - cx, dy = e.clientY - cy;
    const d = Math.hypot(dx, dy);
    if (d < minDist && d < 120) { minDist = d; closest = opt; }
    opt.style.background = 'rgba(255,255,255,0.15)';
  });
  currentHoveredOpt = closest;
  if (closest) closest.style.background = 'rgba(255,255,255,0.4)';
});
document.addEventListener('pointerup', () => {
  clearTimeout(radialTimeout);
  if (radialActive){
    if (currentHoveredOpt){
      const id = currentHoveredOpt.getAttribute('data-device-id');
      cameraSelect.value = id;
      bootCam(id);
    }
    cameraRadialMenu.innerHTML = '';
    radialActive = false;
    currentHoveredOpt = null;
  }
});
function showCameraRadialMenu(){
  cameraRadialMenu.innerHTML = '';
  const opts    = Array.from(cameraSelect.options);
  const count   = opts.length;
  const showCnt = Math.max(1, Math.min(7, count));
  const startA  = -Math.PI/4, endA = Math.PI/4, spread = endA - startA;
  const radius  = 90 + (showCnt - 1) * 6;

  opts.forEach((o, idx) => {
    const ang = startA + idx * (spread / (showCnt - 1 || 1));
    const x   = Math.cos(ang) * radius + 100;
    const y   = Math.sin(ang) * radius + 100;
    const btn = document.createElement('div');
    btn.className = 'camera-option';
    btn.style.left  = `${x}px`; btn.style.top = `${y}px`;
    btn.textContent = o.textContent;
    btn.setAttribute('data-device-id', o.value);
    btn.addEventListener('pointerup', e => {
      e.stopPropagation();
      cameraSelect.value = btn.dataset.deviceId;
      bootCam(btn.dataset.deviceId);
      cameraRadialMenu.innerHTML = '';
      radialActive = false;
    });
    cameraRadialMenu.appendChild(btn);
  });
}

/* ---------- text modal ---------- */
function showModal(){ textModal.style.display='flex'; textInput.focus(); }
function hideModal(){ textModal.style.display='none'; textInput.value=''; lockScroll(); }
textBtn.onclick     = showModal;
textCancel.onclick  = hideModal;
textSubmit.onclick  = () => { userText = textInput.value.trim(); userText && (lastFrameImageData ? updateTxt() : shoot()); hideModal(); };
textInput.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); textSubmit.click(); }});

/* ---------- Worker (inline via Blob) ---------- */
const workerSrc = `
self.onmessage = (e) => {
  const { imageData, film, grainAmt, cmState, colors, hueWidth, wb, vignetteAmt, hal } = e.data;
  const d = imageData.data;
  const useColorMix = cmState.enable && film !== 'acros';

  function rgbToHsv(r,g,b){
    r/=255; g/=255; b/=255;
    const M = Math.max(r,g,b), m = Math.min(r,g,b), delt = M - m;
    let h = 0;
    if (delt > 1e-6){
      if (M === r)      h = ((g - b) / delt) % 6;
      else if (M === g) h = (b - r) / delt + 2;
      else              h = (r - g) / delt + 4;
      h /= 6; if (h<0) h+=1;
    }
    const s = M <= 1e-6 ? 0 : delt / M;
    return [h, s, M];
  }
  function hsvToRgb(h,s,v){
    h = (h%1+1)%1;
    const x = h*6, i = Math.floor(x), f = x - i;
    const p = v*(1-s), q = v*(1-s*f), t = v*(1-s*(1-f));
    let r,g,b;
    if (i===0){ r=v; g=t; b=p; }
    else if (i===1){ r=q; g=v; b=p; }
    else if (i===2){ r=p; g=v; b=t; }
    else if (i===3){ r=p; g=q; b=v; }
    else if (i===4){ r=t; g=p; b=v; }
    else           { r=v; g=p; b=q; }
    return [Math.max(0,Math.min(255,Math.round(r*255))),
            Math.max(0,Math.min(255,Math.round(g*255))),
            Math.max(0,Math.min(255,Math.round(b*255)))];
  }
  function hueDelta(a,b){ const d = Math.abs(a-b); return Math.min(d, 1 - d); }
  function bucketWeight(h, s, center, halfWidth){
    const dh = hueDelta(h, center);
    if (dh >= halfWidth) return 0;
    const wHue = 0.5 * (1 + Math.cos(Math.PI * (dh/halfWidth)));
    const minChroma = 0.02, maxChroma = 0.95;
    const gate = Math.min(1, Math.max(0, (s - minChroma) / (maxChroma - minChroma)));
    return wHue * gate;
  }

  // LFSR noise
  let seed = 1234567;
  function fastNoise(){ seed ^= seed << 13; seed ^= seed >>> 17; seed ^= seed << 5; return ((seed>>>0) / 0x7fffffff) * 2 - 1; }

  // White balance gains (±8 -> ±48% roughly)
  const gainR = 1 + (wb.r || 0) * 0.06;
  const gainB = 1 + (wb.b || 0) * 0.06;

  const W = imageData.width, H = imageData.height;
  const cx = W * 0.5, cy = H * 0.5;
  const maxR = Math.min(W, H) * 0.5;
  const vigPower = (vignetteAmt||0) / 100;

  // 1) Copy base (we'll apply film look first)
  const base = new Uint8ClampedArray(d);

  // 2) Film look + color mix + WB + grain + vignette
  for (let y=0; y<H; y++){
    for (let x=0; x<W; x++){
      const i = (y*W + x) * 4;
      let r = base[i], g = base[i+1], bl = base[i+2];

      if (film === 'acros'){ const a = (r+g+bl)/3; r=g=bl=a; }
      else { const a = (r+g+bl)/3; r = r*.85 + a*.15; g = g*.85 + a*.15; bl = bl*.85 + a*.15; }

      if (useColorMix){
        let [h, s, v] = rgbToHsv(r,g,bl);
        let dH=0, dS=0, dL=0, sumW=0;
        for (let k=0; k<8; k++){
          const w = bucketWeight(h, s, colors[k].center, hueWidth[k]);
          if (w>0){ sumW += w; dH += w*(cmState.dH[k]||0); dS += w*(cmState.dS[k]||0); dL += w*(cmState.dL[k]||0); }
        }
        if (sumW>0){ h=h+dH; s=Math.max(0,Math.min(1,s+dS)); v=Math.max(0,Math.min(1,v+dL)); [r,g,bl]=hsvToRgb(h,s,v); }
      }

      // WB
      r *= gainR; bl *= gainB;

      // Grain
      const n = fastNoise() * (grainAmt||0);
      r += n; g += n; bl += n;

      // Vignette
      if (vigPower > 0){
        const dx = x - cx, dy = y - cy;
        const rr = Math.min(1, Math.hypot(dx,dy) / maxR);
        const vFactor = 1 - vigPower * (rr*rr);
        r *= vFactor; g *= vFactor; bl *= vFactor;
      }

      d[i]   = r<0?0:r>255?255:r;
      d[i+1] = g<0?0:g>255?255:g;
      d[i+2] = bl<0?0:bl>255?255:bl;
    }
  }

  // 3) Halation
  if (hal && hal.enable && hal.amount>0){
    const amount = hal.amount / 100;
    const thr = Math.min(100, Math.max(0, hal.threshold)) / 100;
    const spread = Math.max(1, Math.min(40, Math.floor(hal.spread)));
    const toneHue = ((hal.tone % 360)+360)%360 / 360;

    const mask = new Float32Array(W*H);
    for (let y=0; y<H; y++){
      for (let x=0; x<W; x++){
        const i = (y*W + x) * 4;
        const r = d[i], g = d[i+1], b = d[i+2];
        const lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
        let m = (lum - thr) / (1 - thr);
        if (m < 0) m = 0;
        mask[y*W + x] = m;
      }
    }

    const passes = 3;
    const tmp = new Float32Array(W*H);
    function blurPass(src, dst, rad){
      const w = W, h = H;
      for (let y=0; y<h; y++){
        let acc = 0, n = 0;
        for (let x=-rad; x<=rad; x++){ const xx = Math.min(w-1, Math.max(0,x)); acc += src[y*w + xx]; n++; }
        for (let x=0; x<w; x++){
          dst[y*w + x] = acc / n;
          const xOut = x - rad;
          const xIn  = x + rad + 1;
          if (xOut >= 0){ acc -= src[y*w + xOut]; n--; }
          if (xIn  <  w){ acc += src[y*w + xIn];  n++; }
        }
      }
      for (let x=0; x<w; x++){
        let acc = 0, n = 0;
        for (let y=-rad; y<=rad; y++){ const yy = Math.min(h-1, Math.max(0,y)); acc += dst[yy*w + x]; n++; }
        for (let y=0; y<h; y++){
          const idx = y*w + x;
          src[idx] = acc / n;
          const yOut = y - rad;
          const yIn  = y + rad + 1;
          if (yOut >= 0){ acc -= dst[yOut*w + x]; n--; }
          if (yIn  <  h){ acc += dst[yIn*w + x];  n++; }
        }
      }
    }
    for (let p=0; p<passes; p++) blurPass(mask, tmp, spread);

    const toneRGB = (function(){ const [r,g,b]=hsvToRgb(toneHue, 0.85, 1.0); return [r,g,b]; })();

    for (let i=0, px=0; i<d.length; i+=4, px++){
      const m = mask[px] * amount;
      if (m>1e-4){
        d[i  ] = Math.min(255, d[i  ] + toneRGB[0]*m);
        d[i+1] = Math.min(255, d[i+1] + toneRGB[1]*m);
        d[i+2] = Math.min(255, d[i+2] + toneRGB[2]*m);
      }
    }
  }

  self.postMessage({ imageData }, [imageData.data.buffer]);
};
`;
const worker = new Worker(URL.createObjectURL(new Blob([workerSrc], {type:'application/javascript'})));

/* ---------- shoot / reprocess ---------- */
shutter.onclick = () => { userText=''; shoot(); };

async function shoot(){
  if (!video.videoWidth){ alert('Wait for camera'); return; }

  const w   = video.videoWidth,
        h   = video.videoHeight,
        b   = Math.floor(Math.min(w,h) * 0.09),
        fw  = w + b*2,
        bot = b*2,
        fh  = h + b + bot;

  canvas.width  = fw;
  canvas.height = fh;
  dim           = {fw, fh, b, bot};

  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,fw,fh);
  ctx.drawImage(video, b, b, w, h);

  canvas.style.display = 'block';
  video.style.display  = 'none';
  photo.style.display  = 'none';
  nextBtn.style.display = 'block';
  textBtn.style.display = 'block';
  saveBtn.style.display = 'block';
  lockScroll();

  const roi = ctx.getImageData(b,b,w,h);
  processingEl.style.display = 'flex';
  const effective = getEffectiveSettings();
  worker.postMessage({
    imageData: roi,
    film: effective.filmBase,
    grainAmt: effective.grainAmt,
    cmState: effective.cmState,
    colors,
    hueWidth,
    wb: effective.wb,
    vignetteAmt: effective.vignetteAmt,
    hal: effective.hal
  }, [roi.data.buffer]);

  worker.onmessage = (e) => {
    const { imageData } = e.data;
    ctx.putImageData(imageData, b, b);
    lastFrameImageData = ctx.getImageData(0,0,fw,fh);
    drawTxt(ctx);
    processingEl.style.display = 'none';

    if (calibrationArmed){
      openCalibrationPanel();    // auto-expands accordion and shows sliders
      calibrationArmed = false;
    }
  };
}

function shootReprocess(){
  if (!dim) return;
  const {fw, fh, b} = dim;
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const roiW = canvas.width - b*2;
  const roiH = canvas.height - b*2 - (dim.bot - b);
  const roi = ctx.getImageData(b,b, roiW, roiH);
  processingEl.style.display = 'flex';
  const effective = getEffectiveSettings();
  worker.postMessage({
    imageData: roi,
    film: effective.filmBase,
    grainAmt: effective.grainAmt,
    cmState: effective.cmState,
    colors,
    hueWidth,
    wb: effective.wb,
    vignetteAmt: effective.vignetteAmt,
    hal: effective.hal
  }, [roi.data.buffer]);
  worker.onmessage = (e) => {
    const { imageData } = e.data;
    ctx.putImageData(imageData, b, b);
    lastFrameImageData = ctx.getImageData(0,0,fw,fh);
    drawTxt(ctx);
    processingEl.style.display = 'none';
  };
}

/* ---------- resolve settings ---------- */
function getEffectiveSettings(){
  if (activeProfileName && profiles[activeProfileName]){
    const p = profiles[activeProfileName];
    return {
      filmBase: p.filmBase || 'kodachrome',
      grainAmt: p.grainAmt,
      cmState : p.cmState || cmState,
      wb      : p.wb || wb,
      vignetteAmt: typeof p.vignetteAmt === 'number' ? p.vignetteAmt : 0,
      hal     : p.hal || hal
    };
  }
  return { filmBase: film, grainAmt, cmState, wb, vignetteAmt, hal };
}

/* ---------- text overlay ---------- */
function updateTxt(){
  if (!dim){ return; }
  const {fw, fh, b, bot} = dim;
  const ctx = canvas.getContext('2d');
  if (lastFrameImageData) ctx.putImageData(lastFrameImageData, 0, 0);
  drawTxt(ctx);
}
function drawTxt(ctx){
  if (!userText || !dim) return;
  const {fw, fh, bot} = dim;
  let fs = 131;
  ctx.font = `${fs}px "Mrs Saint Delafield"`;
  while (ctx.measureText(userText).width > fw-20 && fs > 16){
    fs--;
    ctx.font = `${fs}px "Mrs Saint Delafield"`;
  }
  ctx.fillStyle   = '#000';
  ctx.textAlign   = 'center';
  ctx.textBaseline= 'middle';
  ctx.fillText(userText, fw/2, fh - bot/2);
  lastFrameImageData = ctx.getImageData(0,0,fw,fh);
}

/* ---------- save ---------- */
saveBtn.onclick = () => {
  if (!dim){ alert('Take a photo first'); return; }
  const {fw, fh} = dim, scale = 1810/4420, tmp = document.createElement('canvas');
  tmp.width  = Math.floor(fw*scale);
  tmp.height = Math.floor(fh*scale);
  const tctx = tmp.getContext('2d');
  tctx.drawImage(canvas,0,0,tmp.width,tmp.height);
  tmp.toBlob(blob => {
    if (!blob){ alert('Save failed'); return; }
    const a   = document.createElement('a');
    a.href    = URL.createObjectURL(blob);
    a.download= `photo-${Date.now()}.jpg`;
    a.click();
    URL.revokeObjectURL(a.href);
    const fr = new FileReader();
    fr.onloadend = () => localStorage.setItem(`saved-photo-${Date.now()}`, fr.result);
    fr.readAsDataURL(blob);
  }, 'image/jpeg', jpegQ/100);
};

/* ---------- gallery ---------- */
document.getElementById('gallery-btn').onclick = () => {
  const gal  = document.getElementById('gallery-content');
  gal.innerHTML = '';
  const keys = Object.keys(localStorage).filter(k => k.startsWith('saved-photo-')).sort().reverse();
  if (!keys.length){ gal.innerHTML = '<p style="color:#fff">No saved images.</p>'; }
  else{
    keys.forEach(k => { const i = document.createElement('img'); i.src = localStorage.getItem(k); i.style.width = '100px'; gal.appendChild(i); });
  }
  document.getElementById('gallery-overlay').style.display = 'block';
};
document.getElementById('menu-exit-btn').onclick = () => controls.classList.remove('show');

/* ---------- SW & context menu ---------- */
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
document.addEventListener('contextmenu', e => { if (e.target.id !== 'photo') e.preventDefault(); }, {passive:false});

/* ---------- init ---------- */
loadProfiles();
refreshWBUI(); refreshVignetteUI(); refreshHalUI();
bootCam();
lockScroll();
</script>

<div id="gallery-overlay" style="display:none;position:fixed;inset:0;background:#000;z-index:99;overflow:auto;padding:10px">
  <button onclick="this.parentNode.style.display='none'" style="position:fixed;top:10px;right:10px;z-index:100;">Close</button>
  <div id="gallery-content" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:50px"></div>
</div>
</body>
</html>
